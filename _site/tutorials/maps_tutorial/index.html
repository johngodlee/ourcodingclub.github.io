<!DOCTYPE html>
<html lang="en-GB">
	<head>
    	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Spatial Data and Maps</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->
<link rel="stylesheet" href="/css/main.css"/>
<link rel="stylesheet" href="/css/owlcarousel/owl.carousel.css">
<link rel="stylesheet" href="/css/owlcarousel/owl.theme.default.css">

<!-- JS -->
<script src="https://use.fontawesome.com/4dd22df1f8.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/scripts/accordion.js"></script>
<script src="/scripts/jquery.counterup.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.5/waypoints.min.js"></script>
<script src="/scripts/ticker.js"></script>

	</head>
	<body>
    	<header class="header">
	<div class="navigation-bar">
		<div id="navigation-container">
			
				<a class="logo" href="/">
  <img src="/assets/img/logos/logo_stack.svg" alt="Coding Club logo">
</a>

			
			<nav>
				<label for="hamburger">☰</label>
				<input type="checkbox" id="hamburger">
				<ul>
					
						
					<li class="item item-nav">
						<a href="/">Home</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/tutorials.html">Tutorials</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/course.html">Course</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/team.html">Team</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/involve.html">Get involved</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/links.html">Links</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/contact.html">Contact</a>
					</li>
					
				</ul>
			</nav>
		</div>
	</div>
</header>

			<div class="block">
  <center>
  <img src="/img/tutheader_maps.jpg" alt="Img">
</center>
</div>

<h1 id="tutorial-aims">Tutorial Aims:</h1>

<h4 id="1-plot-simple-maps-in-ggplot2">1. Plot simple maps in ggplot2</h4>

<h4 id="2-manipulate-spatial-polygons">2. Manipulate spatial polygons</h4>

<h4 id="3-import-manipulate-and-plot-shapefiles">3. Import, manipulate and plot shapefiles</h4>

<h1 id="steps">Steps:</h1>

<h4 id="1-why-use-r-to-make-maps"><a href="#why">1. Why use <code class="language-plaintext highlighter-rouge">R</code> to make maps?</a></h4>

<h4 id="2-downloading-the-relevant-packages"><a href="#download">2. Downloading the relevant packages</a></h4>

<h4 id="3-getting-your-head-around-spatial-data"><a href="#map_data">3. Getting your head around spatial data</a></h4>

<h4 id="4-creating-a-map-using-ggplot2-and-rworldmap"><a href="#create_map">4. Creating a map using <code class="language-plaintext highlighter-rouge">ggplot2</code> and <code class="language-plaintext highlighter-rouge">rworldmap</code></a></h4>

<h4 id="5-using-shapefiles"><a href="#shp">5. Using shapefiles</a></h4>

<h3 id="all-the-resources-for-this-tutorial-including-some-helpful-cheatsheets-can-be-downloaded-from-this-github-repository-clone-and-download-the-repo-as-a-zipfile-then-unzip-it">All the resources for this tutorial, including some helpful cheatsheets can be downloaded from <a href="https://github.com/ourcodingclub/CC-6-Maps" target="_blank" rel="noopener noreferrer">this Github repository</a>. Clone and download the repo as a zipfile, then unzip it.</h3>

<p>Next, open up a new R Script where you will add the code for your maps. Set the folder you just downloaded as your working directory by running the code below, replacing <code class="language-plaintext highlighter-rouge">PATH_TO_FOLDER</code> with the location of the downloaded folder on your computer, e.g. <code class="language-plaintext highlighter-rouge">~/Downloads/CC-6-Maps-master</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">setwd</span><span class="p">(</span><span class="s2">"PATH_TO_FOLDER"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><a name="why"></a></p>

<h2 id="why-use-r-for-spatial-data">Why use R for spatial data?</h2>

<h5 id="less-clicking"><strong>Less clicking:</strong></h5>
<ul>
  <li>Most conventional GIS software use a Graphical User Interface (GUI) which makes them easier to fumble through when you don’t know what you’re doing, but point and click interfaces become very laborious when performing analyses for the <em>n</em> th time or when you really know your way around the software. R uses a Command Line Interface, using text commands, so while there may be more of a learning curve to begin with, it’s very efficient once you know what to do.</li>
</ul>

<h5 id="reproducible-analyses-with-new-data"><strong>Reproducible analyses with new data:</strong></h5>
<ul>
  <li>Imagine you have a project where you are given new data every week, which you want to compare using maps. Using a GUI, you would have to repeat your analyses step by step, every time the data came in, being careful to maintain formatting between maps. Using the command line in R, you only have to plug in the new data to the script and the maps will look the same every time.</li>
</ul>

<h5 id="its-free"><strong>It’s free:</strong></h5>
<ul>
  <li>While ArcMap and SuperGIS cost money to use, R packages are free and probably always will be.</li>
</ul>

<h5 id="a-range-of-gis-packages-for-different-applications"><strong>A range of GIS packages for different applications:</strong></h5>
<ul>
  <li>Using the R package system you can find the right GIS application for your project, and you can adapt and hack the packages already there to create something specific for your project.</li>
</ul>

<p><a name="download"></a></p>

<h2 id="downloading-the-relevant-packages">Downloading the relevant packages</h2>

<p>Load the following packages into R by running the following lines of code in your R script. Remember if you haven’t installed the packages first, you will have to use <code class="language-plaintext highlighter-rouge">install.packages("PACKAGE_NAME")</code> first:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">  </span><span class="c1"># ggplot() fortify()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">  </span><span class="c1"># %&gt;% select() filter() bind_rows()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span><span class="w">  </span><span class="c1"># readOGR() spTransform()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">  </span><span class="c1"># intersect()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggsn</span><span class="p">)</span><span class="w">  </span><span class="c1"># north2() scalebar()</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rworldmap</span><span class="p">)</span><span class="w">  </span><span class="c1"># getMap()</span><span class="w">
</span></code></pre></div></div>

<p>In previous versions of this workshop, we used the <a href="https://github.com/dkahle/ggmap" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">ggmap</code> package</a> for grabbing background map tiles from Google Maps and other sources, but this package has become difficult to use, especially since Google now requires a non-free API key to download their map tiles. There are lots of other resources online for ggmap and I’d still recommend having a look if you have specific need for Google Maps basemaps. For now however, we will focus on other R packages.</p>

<p><a name="map_data"></a></p>

<h2 id="getting-your-head-around-map-data">Getting your head around map data</h2>

<p>The easiest way to think about map data is to first imagine a graph displaying whatever data you want, but where the x and y axes denote spatial coordinates such as longitude and latitude instead of a variable:</p>

<center><img src="/img/Trout_Europe_Plot.jpeg" alt="Img" style="width: 700px;"></center>

<p>Then it’s a simple case of adding a background map to your image to place the data points in the real world. In this case, the map was pulled from data provided by the <code class="language-plaintext highlighter-rouge">maps</code> package:</p>

<center><img src="/img/Trout_Europe_Map.jpeg" alt="Img" style="width: 700px;"></center>

<p>That was a simple example, maps can incorporate more complex elements like polygons and lines, each with their own values:</p>

<center><img src="/img/map_FEOW_annot.png" alt="Img" style="width: 700px;"></center>

<p><a name="create_map"></a></p>

<h2 id="creating-a-map-using-ggplot2-and-rworldmap">Creating a map using <code class="language-plaintext highlighter-rouge">ggplot2</code> and <code class="language-plaintext highlighter-rouge">rworldmap</code>
</h2>

<p>In this part of the workshop we are going to create a map showing occurrence records of two species of bird. Rueppell’s Vulture (<em>Gyps rueppellii</em>) feeds on large mammalian carrion and the African Penguin (<em>Spheniscus demersus</em>) feeds on small marine fish. It’s likely that their distributions have distinct spatial patterns, we shall see! We will use species occurence data from the <a href="http://www.gbif.org/" target="_blank" rel="noopener noreferrer">Global Biodiversity Information Facility (GBIF)</a>, which can be found in <a href="https://github.com/ourcodingclub/CC-6-Maps" target="_blank" rel="noopener noreferrer">the repository</a> for this tutorial, which you should download if you haven’t done so already.</p>

<p>First, import the data we need, <code class="language-plaintext highlighter-rouge">Gyps_rueppellii_GBIF.csv</code> and <code class="language-plaintext highlighter-rouge">Spheniscus_dermersus_GBIF.csv</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vulture</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"Gyps_rueppellii_GBIF.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\t"</span><span class="p">)</span><span class="w">
</span><span class="n">penguin</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"Spheniscus_dermersus_GBIF.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\t"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now onto cleaning up the data using <code class="language-plaintext highlighter-rouge">dplyr</code>. If you are keen to learn more about using the <code class="language-plaintext highlighter-rouge">dplyr</code> package, check out our <a href="https://ourcodingclub.github.io/2017/01/16/piping.html" target="_blank" rel="noopener noreferrer">tutorial on data formatting and manipulation</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Keep only the columns we need</span><span class="w">
</span><span class="n">vars</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"gbifid"</span><span class="p">,</span><span class="w"> </span><span class="s2">"scientificname"</span><span class="p">,</span><span class="w"> </span><span class="s2">"locality"</span><span class="p">,</span><span class="w"> </span><span class="s2">"decimallongitude"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"decimallatitude"</span><span class="p">,</span><span class="w"> </span><span class="s2">"coordinateuncertaintyinmeters"</span><span class="p">)</span><span class="w">

</span><span class="n">vulture_trim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vulture</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">one_of</span><span class="p">(</span><span class="n">vars</span><span class="p">))</span><span class="w">
</span><span class="n">penguin_trim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">penguin</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">one_of</span><span class="p">(</span><span class="n">vars</span><span class="p">))</span><span class="w">
	</span><span class="c1"># `one_of()` is part of `dplyr` and selects all columns specified in `vars`</span><span class="w">

</span><span class="c1"># Combine the dataframes</span><span class="w">
</span><span class="n">pc_trim</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">vulture_trim</span><span class="p">,</span><span class="w"> </span><span class="n">penguin_trim</span><span class="p">)</span><span class="w">

</span><span class="c1"># Check column names and content</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">pc_trim</span><span class="p">)</span><span class="w">

</span><span class="c1"># Check that species names are consistent</span><span class="w">
</span><span class="n">unique</span><span class="p">(</span><span class="n">pc_trim</span><span class="o">$</span><span class="n">scientificname</span><span class="p">)</span><span class="w">
  </span><span class="c1"># Needs cleaning up</span><span class="w">

</span><span class="c1"># Clean up "scientificname" to make names consistent</span><span class="w">
</span><span class="n">pc_trim</span><span class="o">$</span><span class="n">scientificname</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pc_trim</span><span class="o">$</span><span class="n">scientificname</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">recode</span><span class="p">(</span><span class="s2">"Gyps rueppellii (A. E. Brehm, 1852)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Gyps rueppellii"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Gyps rueppellii subsp. erlangeri Salvadori, 1908"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Gyps rueppellii"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Gyps rueppelli rueppelli"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Gyps rueppellii"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Spheniscus demersus (Linnaeus, 1758)"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Spheniscus demersus"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Checking names to ensure only two names are now present</span><span class="w">
</span><span class="n">unique</span><span class="p">(</span><span class="n">pc_trim</span><span class="o">$</span><span class="n">scientificname</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now we can make a preliminary plot to make sure the data looks right. Remember, a map is just a graph with longitude and latitude as the x and y axes:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">prelim_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">pc_trim</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">,</span><span class="w"> 
    </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scientificname</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<p>Note that putting your entire ggplot code in brackets () creates the graph and then shows it in the plot viewer. If you don’t have the brackets, you’ve only created the object, but haven’t visualized it. You would then have to call the object such that it will be displayed by just typing <code class="language-plaintext highlighter-rouge">prelim_plot</code> after you’ve created the “prelim_plot” object.</p>

<center><img src="/img/bird_prelim_ggplot.jpeg" alt="Img" style="width: 700px;"></center>

<p>If you squint, you might be able to see the southern African cape, with lots of penguins on it. It looks like some of the penguin populations might be from zoos in U.S cities, but we only want to plot natural populations, so let’s remove those entries by removing records with a longitude less than -50:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pc_trim_us</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pc_trim</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">decimallongitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-50</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Plot it again:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">zoomed</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">pc_trim_us</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">,</span><span class="w"> 
    </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scientificname</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/bird_crop_ggplot.png" alt="Img" style="width: 700px;"></center>

<p>Now we can add some simple country outline data from the <code class="language-plaintext highlighter-rouge">rworldmap</code> package, which has data of country boundaries at various resolutions.</p>

<p>First we need to pull the map data:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getMap</span><span class="p">(</span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"low"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">world</code> is a SpatialPolygonsDataFrame, a complex object type with specific slots for different types of data.</p>

<p><code class="language-plaintext highlighter-rouge">world@data</code> contains a dataframe with metadata for each polygon. Columns can be accessed like this: <code class="language-plaintext highlighter-rouge">world@data$REGION</code>.</p>

<p><code class="language-plaintext highlighter-rouge">world@polygons</code> contains coordinate data for all the polygons in the object, in the form of a list</p>

<p><code class="language-plaintext highlighter-rouge">world@plotOrder</code> contains an integer vector specifying the order in which polygons should be drawn, to deal with holes and overlaps.</p>

<p><code class="language-plaintext highlighter-rouge">world@bbox</code> contains the minimum and maximum x and y coordinates in which the polygons are found</p>

<p><code class="language-plaintext highlighter-rouge">world@proj4string</code> contains the Coordinate Reference System (CRS) for the polygons. A CRS specifies how the coordinates of the 2D map displayed on the computer screen are related to the real globe, which is roughly spherical. There are lot’s of different CRSs, used for maps of different scales, or of different parts of the globe (e.g. the poles vs. the equator) and it is important to keep them consistent amongst all the elements of your map. You can use <code class="language-plaintext highlighter-rouge">proj4string()</code> to check the CRS. For more information on CRSs have a look at “Coord_Ref_Systems.pdf” in <a href="https://github.com/ourcodingclub/CC-6-Maps" target="_blank" rel="noopener noreferrer">the repository you downloaded earlier</a>:</p>

<p>Now we have to check that the shapefile has the right Coordinate Reference System (CRS) to be read by <code class="language-plaintext highlighter-rouge">ggplot2</code>.</p>

<p>You can plot <code class="language-plaintext highlighter-rouge">world</code> by simply adding it to your ggplot2 call using <code class="language-plaintext highlighter-rouge">geom_polygon()</code>  and designating the <code class="language-plaintext highlighter-rouge">ggplot()</code> as a map using <code class="language-plaintext highlighter-rouge">coord_quickmap()</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">with_world</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">world</span><span class="p">,</span><span class="w"> 
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">),</span><span class="w">
		</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_trim_us</span><span class="p">,</span><span class="w">  </span><span class="c1"># Add and plot species data</span><span class="w">
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">,</span><span class="w"> 
			</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scientificname</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">coord_quickmap</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Prevents stretching when resizing</span><span class="w">
	</span><span class="n">theme_classic</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Remove ugly grey background</span><span class="w">
	</span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Longitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Latitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Species"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/map_world_penguins.png" alt="Img" style="width: 700px;"></center>

<p>You can also subset the contents of <code class="language-plaintext highlighter-rouge">world</code>, to only plot a particular country or set of countries. Say we wanted to only plot the distribution of vultures and penguins in southern Africa, in the countries of South Africa, Namibia, Botswana, Zimbabwe. We can subset the column <code class="language-plaintext highlighter-rouge">world@data$ADMIN</code> to only include those country names:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make a vector of country names</span><span class="w">
</span><span class="n">saf_countries</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"South Africa"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Namibia"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Botswana"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Zimbabwe"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Call the vector in `borders()`</span><span class="w">
</span><span class="n">world_saf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">world</span><span class="p">[</span><span class="n">world</span><span class="o">@</span><span class="n">data</span><span class="o">$</span><span class="n">ADMIN</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">saf_countries</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">%in%</code> is a special R operator which matches multiple values in a vector, rather than just a single value like <code class="language-plaintext highlighter-rouge">==</code>.</p>

<p>Then define the x and y axis limits in <code class="language-plaintext highlighter-rouge">ggplot()</code> using <code class="language-plaintext highlighter-rouge">xlim()</code> and <code class="language-plaintext highlighter-rouge">ylim()</code> with a bit of trial and error:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">southern_africa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">world_saf</span><span class="p">,</span><span class="w"> 
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">),</span><span class="w">
		</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_trim_us</span><span class="p">,</span><span class="w">  </span><span class="c1"># Add and plot speices data</span><span class="w">
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">,</span><span class="w"> 
			</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scientificname</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">coord_quickmap</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">xlim</span><span class="p">(</span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">35</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Set x axis limits, xlim(min, max)</span><span class="w">
	</span><span class="n">ylim</span><span class="p">(</span><span class="m">-35</span><span class="p">,</span><span class="w"> </span><span class="m">-15</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Set y axis limits</span><span class="w">
	</span><span class="n">theme_classic</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="c1"># Remove ugly grey background</span><span class="w">
	</span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Longitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Latitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">guide_legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Species"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/map_saf_penguins.png" alt="Img" style="width: 800px;"></center>

<p><a name="shp"></a></p>

<h2 id="using-shapefiles">Using shapefiles</h2>

<p>Shapefiles are a data format developed by <a href="http://www.esri.com" target="_blank" rel="noopener noreferrer">ESRI</a> used to hold information on spatial objects. They are pretty ubiquitous and can be used by a lot of GIS packages Shapefiles can hold polygon, line or point data. Despite the name, a shapefile consists of a few different files:</p>

<p><strong>Mandatory files:</strong></p>

<p><code class="language-plaintext highlighter-rouge">.shp</code> = The main file containing the geometry data</p>

<p><code class="language-plaintext highlighter-rouge">.shx</code> = An index file</p>

<p><code class="language-plaintext highlighter-rouge">.dbf</code> = An attribute file holding information on each object</p>

<p><strong>Common additional files:</strong></p>

<p><code class="language-plaintext highlighter-rouge">.prj</code> = A file containing information on the Coordinate Reference system</p>

<p><code class="language-plaintext highlighter-rouge">.shp.xml</code> = a file containing object metadata, citations for data, etc.</p>

<p><strong>And many more!</strong></p>

<p>We are going to use a shapefile of the World’s Freshwater Ecoregions provided by <a href="http://www.feow.org" target="_blank" rel="noopener noreferrer">The Nature Conservancy</a> to investigate the range of the Brown Trout in Europe using data from the <a href="http://www.gbif.org" target="_blank" rel="noopener noreferrer">GBIF database</a>.</p>

<p>Read in the GBIF data for the Brown Trout:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">brown_trout</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"Brown_Trout_GBIF_clip.csv"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Check that the data is displaying correctly using <code class="language-plaintext highlighter-rouge">ggplot()</code> like in the previous example:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">trout_check</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">brown_trout</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/trout_prelim.png" alt="Img" style="width: 700px;"></center>

<p>We can roughly see the outline of Scandinavia and maybe the Northern Mediterranean if you squint.</p>

<p>To plot a preliminary map, crop the world map provided by the <code class="language-plaintext highlighter-rouge">rworldmap</code> package using:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">clipper_europe</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as</span><span class="p">(</span><span class="n">extent</span><span class="p">(</span><span class="m">-10</span><span class="p">,</span><span class="w"> </span><span class="m">32</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="p">,</span><span class="w"> </span><span class="m">72</span><span class="p">),</span><span class="w"> </span><span class="s2">"SpatialPolygons"</span><span class="p">)</span><span class="w">

</span><span class="n">proj4string</span><span class="p">(</span><span class="n">clipper_europe</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="n">proj4string</span><span class="p">(</span><span class="n">world</span><span class="p">))</span><span class="w">

</span><span class="n">world_clip</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">world</span><span class="p">,</span><span class="w"> </span><span class="n">clipper_europe</span><span class="p">)</span><span class="w">

</span><span class="n">world_clip_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fortify</span><span class="p">(</span><span class="n">world_clip</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The first line uses <code class="language-plaintext highlighter-rouge">extent()</code> to make a SpatialPolygons object which defines a bounding box inside which to crop the world map polygons. The arguments in <code class="language-plaintext highlighter-rouge">extent()</code> are: <code class="language-plaintext highlighter-rouge">extent(min_longitude, max_longitude, min_latitude, max_latitude)</code>.</p>

<p>The second line changes the coordinate reference systems of both the counding box and the world map to be equal.</p>

<p>The third line uses <code class="language-plaintext highlighter-rouge">intersect()</code> to clip <code class="language-plaintext highlighter-rouge">world</code> by the area of the bounding box, <code class="language-plaintext highlighter-rouge">clipper_europe</code>.</p>

<p>The fourth line converts the SpatialPolygonsDataFrame to a normal flat dataframe for use in <code class="language-plaintext highlighter-rouge">ggplot()</code></p>

<p>Then we can plot the map tiles with the data using <code class="language-plaintext highlighter-rouge">geom_polygon()</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">trout_map</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">world_clip_f</span><span class="p">,</span><span class="w"> 
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">),</span><span class="w">
		</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">geom_point</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w">
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">),</span><span class="w">
		</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brown_trout</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Longitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Latitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">coord_quickmap</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/trout_map_country.png" alt="Img" style="width: 700px;"></center>

<p>The country outlines work well, but to tell us more about the habitat the Brown Trout lives in we can also plot the ecoregions data on the map.</p>

<p>To read in the shapefiles we can use <code class="language-plaintext highlighter-rouge">readOGR()</code>, which converts a shapefile into a SpatialPolygons object that can be interpreted by R. <code class="language-plaintext highlighter-rouge">dsn = "FEOW-TNC"</code> gives the name of the folder where the shapefile can be found, <code class="language-plaintext highlighter-rouge">layer = "FEOWv1_TNC"</code> gives the name of the files to read in. It’s important to keep filenames identical in a shapefile:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shpdata_FEOW</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readOGR</span><span class="p">(</span><span class="n">dsn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"FEOW-TNC"</span><span class="p">,</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"FEOWv1_TNC"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now we have to check that the shapefile has the right Co-ordinate Reference System (CRS) to be read by <code class="language-plaintext highlighter-rouge">ggplot2</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proj4string</span><span class="p">(</span><span class="n">shpdata_FEOW</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>To transform the CRS, we can use <code class="language-plaintext highlighter-rouge">spTransform</code> and specify the correct CRS, which in this case is <a href="http://spatialreference.org/ref/epsg/wgs-84/" target="_blank" rel="noopener noreferrer">EPSG:WGS84</a> (<code class="language-plaintext highlighter-rouge">+proj=longlat +datum=WGS84</code>). WGS84 is normallly used to display large maps of the world.:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shpdata_FEOW</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">spTransform</span><span class="p">(</span><span class="n">shpdata_FEOW</span><span class="p">,</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="s2">"+proj=longlat +datum=WGS84"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>At this point I wouldn’t recommend plotting <code class="language-plaintext highlighter-rouge">shpdata_FEOW</code>, it’s a pretty big file, but so you can get an idea of what it looks like:</p>

<center><img src="/img/ecoregions_global_map.png" alt="Img" style="width: 700px;"></center>

<p>The shapefile contains ecoregions for the entire world, but we only want to plot the ecoregions where the brown trout is found. <code class="language-plaintext highlighter-rouge">shpdata_FEOW</code> is a SpatialPolygonsDataFrame, so we can use the same method as before to crop the object to the extent of a bounding box, using <code class="language-plaintext highlighter-rouge">intersect():</code></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shpdata_FEOW_clip</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">shpdata_FEOW</span><span class="p">,</span><span class="w"> </span><span class="n">clipper_europe</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Plot <code class="language-plaintext highlighter-rouge">shpdata_FEOW_clip</code> to see that <code class="language-plaintext highlighter-rouge">intersect()</code> has cropped out polygons that were outside our bounding box, and has helpfully joined up the perimeters of any polygons that straddle the edge of the bounding box:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">shpdata_FEOW_clip</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/ecoregions_clipped_map.png" alt="img" style="width: 700px;"></center>

<p>Then we need to restructure the object into a data frame ready for plotting. the dataframe needs to contain the id for each polygon, in this case the name of the ecoregion it is from. explore the contents of <code class="language-plaintext highlighter-rouge">shpdata_feow_clip</code>, using <code class="language-plaintext highlighter-rouge">str</code>. Remember that <code class="language-plaintext highlighter-rouge">@</code> accesses slots within the <code class="language-plaintext highlighter-rouge">shpdata_FEOW</code> spatial object:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">str</span><span class="p">(</span><span class="n">shpdata_FEOW_clip</span><span class="o">@</span><span class="n">data</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ECOREGION</code> contains all the data for the different types of ecoregions, they have names like “Aegean Drainages” and “Central Prairie”. Now we can use <code class="language-plaintext highlighter-rouge">ECOREGION</code> as an identifier in the <code class="language-plaintext highlighter-rouge">fortify()</code> command to transform the spatial object to a dataframe, where each polygon will be given an <code class="language-plaintext highlighter-rouge">id</code> of which <code class="language-plaintext highlighter-rouge">ECOREGION</code> it is from. Transforming to a dataframe is necessary to keep the metadata for each polygon, which is necessary to colour the points in the ggplot.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shpdata_FEOW_clip_f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fortify</span><span class="p">(</span><span class="n">shpdata_FEOW_clip</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ECOREGION"</span><span class="p">)</span><span class="w">  </span><span class="c1"># this could take a while</span><span class="w">
</span></code></pre></div></div>

<p>Now, plot the map, point data and shapefile together. The ecoregion polygons can be plotted using <code class="language-plaintext highlighter-rouge">geom_polygon()</code>, just like when you plotted the country outlines, specifying that the map (i.e. the polygons) and the data (i.e. the colours filling the shapes) both come from the dataframe, <code class="language-plaintext highlighter-rouge">color = black</code> makes the shape outlines black:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">map_FEOW</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">geom_polygon</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shpdata_FEOW_clip_f</span><span class="p">,</span><span class="w">
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">long</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">),</span><span class="w">
		</span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">geom_point</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w">
		</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimallatitude</span><span class="p">),</span><span class="w">
		</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brown_trout</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">theme_classic</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s2">"bottom"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="o">=</span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Longitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Latitude"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
	</span><span class="n">coord_quickmap</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/map_feow.png" alt="Img" style="width: 700px;"></center>

<p>The super useful thing about plotting maps with <code class="language-plaintext highlighter-rouge">ggplot()</code> is that you can add other elements to the plot using normal <code class="language-plaintext highlighter-rouge">ggplot2</code> syntax. Imagine that we want to indicate a potential area for a trout re-introduction program. Finland and Estonia have hardly any trout, but would probably have the right conditions according to the ecoregions:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">map_FEOW_annot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map_FEOW</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">annotate</span><span class="p">(</span><span class="s2">"rect"</span><span class="p">,</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">35</span><span class="p">,</span><span class="w"> </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">55</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">65</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
	</span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">27.5</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">61</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Restock\nArea"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>To further explore which ecoregions would be suitable for a trout re-introduction program, you can also check which trout records fall within which ecoregion polygons using the <code class="language-plaintext highlighter-rouge">rgdal</code> package. First, create a SpatialPoints object from the Brown Trout records:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">brown_trout_sp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SpatialPoints</span><span class="p">(</span><span class="w">
	</span><span class="n">coords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">brown_trout</span><span class="o">$</span><span class="n">decimallongitude</span><span class="p">,</span><span class="w"> </span><span class="n">brown_trout</span><span class="o">$</span><span class="n">decimallatitude</span><span class="p">),</span><span class="w">
	</span><span class="n">proj4string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRS</span><span class="p">(</span><span class="n">proj4string</span><span class="p">(</span><span class="n">shpdata_FEOW_clip</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">coords =</code>  uses the coordinates from the brown trout dataset formatted as a dataframe. the CRS (<code class="language-plaintext highlighter-rouge">proj4string</code>) is set to be the CRS of the ecoregions spatial object.</p>

<p><code class="language-plaintext highlighter-rouge">over()</code> from the <code class="language-plaintext highlighter-rouge">sp</code> package (loaded by default by many other R spatial analysis packages) then creates a dataframe with the same number of rows as <code class="language-plaintext highlighter-rouge">brown_trout_sp</code>, where each row contains the data of the polygon in which the data point is found.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">point_match</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">over</span><span class="p">(</span><span class="w">
	</span><span class="n">brown_trout_sp</span><span class="p">,</span><span class="w"> 
	</span><span class="n">shpdata_FEOW_clip</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>It’s then easy to use commands from the <code class="language-plaintext highlighter-rouge">dplyr</code> package to create a summary table counting the number of rows grouped by <code class="language-plaintext highlighter-rouge">ECOREGION</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">point_match</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">group_by</span><span class="p">(</span><span class="n">ECOREGION</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">tally</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
	</span><span class="n">arrange</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Northern Baltic Drainages</code>, <code class="language-plaintext highlighter-rouge">Norwegian Sea Drainages</code> and <code class="language-plaintext highlighter-rouge">Eastern Iberia</code> all have over 10,000 records.</p>

<p>Finally, to make our map look more professional, we can add a scale bar and a north arrow. To add these you can use the <code class="language-plaintext highlighter-rouge">ggsn</code> package.</p>

<p>Adding a scalebar. <code class="language-plaintext highlighter-rouge">transform = TRUE</code> confirms that the coordinates of the map are in decimal degrees, if this was set to <code class="language-plaintext highlighter-rouge">FALSE</code> <code class="language-plaintext highlighter-rouge">scalebar()</code> would assume the coordinates were in metres. <code class="language-plaintext highlighter-rouge">dist</code> defines the distance for each gradation of the scalebar, <code class="language-plaintext highlighter-rouge">height</code> defines the height of the scalebar according to y axis measurements, so <code class="language-plaintext highlighter-rouge">0.01</code> is 0.01 decimal degrees latitude. <code class="language-plaintext highlighter-rouge">location</code> sets the location of the scalebar, in this case to the <code class="language-plaintext highlighter-rouge">bottomright</code>. <code class="language-plaintext highlighter-rouge">anchor</code> sets the location of the bottom right corner of the scalebar box, in map units of decimal degrees. If <code class="language-plaintext highlighter-rouge">location = topleft</code>, <code class="language-plaintext highlighter-rouge">anchor</code> would instead define the location of the top left corner of the scalebar box.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map_FEOW_scale</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map_FEOW_annot</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scalebar</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shpdata_FEOW_clip_f</span><span class="p">,</span><span class="w">
    </span><span class="n">transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">dist_unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"km"</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">=</span><span class="s1">'WGS84'</span><span class="p">,</span><span class="w">
    </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomright"</span><span class="p">,</span><span class="w"> </span><span class="n">anchor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">25</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">32</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Adding a north arrow. Currently the default <code class="language-plaintext highlighter-rouge">north</code> command from the <code class="language-plaintext highlighter-rouge">ggsn</code> package doesn’t work properly, so we can’t just do <code class="language-plaintext highlighter-rouge">map_FEOW + north()</code>. Instead <code class="language-plaintext highlighter-rouge">north2()</code> has to be used as an alternative. You can change the symbol by changing <code class="language-plaintext highlighter-rouge">symbol</code> to any integer from 1 to 8. You might get an error saying: “Error: Don’t know how to add o to a plot” and your arrow might be placed in a strange location - you can change the values for <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> till your arrow moves to where you want it to be.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">north2</span><span class="p">(</span><span class="n">map_FEOW_scale</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.85</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center><img src="/img/map_FEOW_annot.png" alt="Img" style="width: 700px;"></center>

<p>There are lots of ways to visualise and analyse spatial data in R. This workshop touched on a few of them, focussing on workflows involving <code class="language-plaintext highlighter-rouge">ggplot2</code>, but it is recommended to explore more online resources for your specific needs.</p>

<hr>

<hr>

<p><strong>Check out <a href="https://ourcodingclub.github.io/workshop/" target="_blank" rel="noopener noreferrer">this page</a> to learn how you can get involved! We are very happy to have people use our tutorials and adapt them to their needs. We are also very keen to expand the content on the website, so feel free to get in touch if you’d like to write a tutorial!</strong></p>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-ShareAlike 4.0 International License</a>. <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="Img" style="width: 100px;"></a></p>

<h3><a href="https://www.surveymonkey.co.uk/r/NMD3N5K" target="_blank" rel="noopener noreferrer">  We would love to hear your feedback, please fill out our survey!</a></h3>
<p><br></p>
<h3>  You can contact us with any questions on <a href="mailto:ourcodingclub@gmail.com?Subject=Tutorial%20question" target="_top">ourcodingclub@gmail.com</a>
</h3>
<p><br></p>
<h3>  Related tutorials:</h3>

<ul>
  
  
</ul>
<p><br></p>
<h3>  Subscribe to our mailing list:</h3>
<div class="container">
	<div class="block">
        <!-- subscribe form start -->
		<div class="form-group">
			<form action="https://getsimpleform.com/messages?form_api_token=de1ba2f2f947822946fb6e835437ec78" method="post">
			<div class="form-group">
				<input type="text" class="form-control" name="Email" placeholder="Email" required="">
			</div>
			<div>
                        	<button class="btn btn-default" type="submit">Subscribe</button>
                    	</div>
                	</form>
		</div>
	</div>
</div>

<ul class="social-icons">
	<li>
		<h3>
			<a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer"> Follow our coding adventures on Twitter! <i class="fa fa-twitter"></i></a>
		</h3>
	</li>
</ul>

    	<footer class="footer">
	<hr>
	<div class="footer-container">
    	<ul class="footer-link-list">
        	<li><a href="/tutorials">Tutorials</a></li>
        	<li><a href="/team">About Us</a></li>
        	<li><a href="/contact">Contact us</a></li>
	    	<li><a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer">Follow us on Twitter</a></li>
    	</ul>
    	<div class="footer-text">
			<p>We are happy for people to use and further develop our tutorials - please give credit to Coding Club by linking to <a href="https://ourcodingclub.github.io/" target="_blank" rel="noopener noreferrer">our website</a>. We are also happy to discuss possible collaborations, so get in touch at <b>ourcodingclub@gmail.com</b></p>
    		<p>See our <a href="/terms">Terms of Use</a> and our <a href="/privacy">Data Privacy policy</a>.</p>
			<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-ShareAlike 4.0 International License</a></p>
			<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img class="license" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="CC-by-sa-4.0"></a>
    	</div>
    </div>
</footer>

<!-- JS -->
<script src="/scripts/owl.carousel.js"></script>
<script src="/scripts/owl.carousel-init.js"></script>
<script src="/scripts/reveal.js"></script>


	
	</body>
</html>
