<!DOCTYPE html>
<html lang="en-GB">
	<head>
    	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Advanced data manipulation and visualisation</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->
<link rel="stylesheet" href="/css/main.css"/>
<link rel="stylesheet" href="/css/owlcarousel/owl.carousel.css">
<link rel="stylesheet" href="/css/owlcarousel/owl.theme.default.css">

<!-- JS -->
<script src="https://use.fontawesome.com/4dd22df1f8.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/scripts/accordion.js"></script>
<script src="/scripts/jquery.counterup.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.5/waypoints.min.js"></script>
<script src="/scripts/ticker.js"></script>

	</head>
	<body>
    	<header class="header">
	<div class="navigation-bar">
		<div id="navigation-container">
			
				<a class="logo" href="/">
  <img src="/assets/img/logos/logo_stack.svg" alt="Coding Club logo">
</a>

			
			<nav>
				<label for="hamburger">☰</label>
				<input type="checkbox" id="hamburger">
				<ul>
					
						
					<li class="item item-nav">
						<a href="/">Home</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/tutorials.html">Tutorials</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/course.html">Course</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/team.html">Team</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/involve.html">Get involved</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/links.html">Links</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/contact.html">Contact</a>
					</li>
					
				</ul>
			</nav>
		</div>
	</div>
</header>

			<h3 id="tutorial-aims">Tutorial Aims:</h3>

<h4 id="-1-create-a-reproducible-report-using-markdown-"><a href="#markdown"> 1. Create a reproducible report using Markdown </a></h4>
<h4 id="-2-learn-about-the-tidyverse-"><a href="#tidyverse"> 2. Learn about the <code class="language-plaintext highlighter-rouge">tidyverse</code> </a></h4>
<h4 id="-3-use-pipes-to-make-figures-with-large-datasets-"><a href="#pipes"> 3. Use pipes to make figures with large datasets </a></h4>
<h4 id="-4-download-and-map-data-from-large-datasets-"><a href="#mapping"> 4. Download and map data from large datasets </a></h4>

<p></p>
<center> <img src="/img/bes_qe.png" alt="Img"> </center>

<h2 id="this-tutorial-was-developed-for-the-british-ecological-society-quantitative-ecology-special-interest-group-advanced-r-workshop-check-out-the-qe-sig-website-for-more-info">This tutorial was developed for the British Ecological Society Quantitative Ecology Special Interest Group Advanced R workshop. <a href="https://bes-qsig.github.io" target="_blank" rel="noopener noreferrer">Check out the QE SIG website for more info!</a>
</h2>
<p>You can follow the BES QE SIG on <a href="https://twitter.com/BES_QE_SIG" target="_blank" rel="noopener noreferrer">Twitter</a>, too.</p>

<h3 id="all-the-files-you-need-to-complete-this-tutorial-can-be-downloaded-from-this-repository-click-on-clonedownloaddownload-zip-and-unzip-the-folder-or-clone-the-repository-to-your-own-github-account">All the files you need to complete this tutorial can be downloaded from <a href="https://github.com/ourcodingclub/CC-Liverpool" target="_blank" rel="noopener noreferrer">this repository</a>. <strong>Click on <code class="language-plaintext highlighter-rouge">Clone/Download/Download ZIP</code> and unzip the folder, or clone the repository to your own GitHub account.</strong>
</h3>

<p><a name="markdown"></a></p>

<h2 id="1-create-a-reproducible-report-using-markdown">1. Create a reproducible report using Markdown</h2>

<h3 id="what-is-r-markdown">What is R Markdown?</h3>

<p>R Markdown allows you to create documents that serve as a neat record of your analysis. In the world of reproducible research, we want other researchers to easily understand what we did in our analysis. You might choose to create an R markdown document as an appendix to a paper or project assignment that you are doing, upload it to an online repository such as Github, or simply to keep as a personal record so you can quickly look back at your code and see what you did. R Markdown presents your code alongside its output (graphs, tables, etc.) with conventional text to explain it, a bit like a notebook. Your report can also be what you base your future methods and results sections in your manuscripts, thesis chapters, etc.</p>

<p>R Markdown uses <a href="http://www.markdowntutorial.com" target="_blank" rel="noopener noreferrer">markdown syntax</a>. Markdown is a very simple ‘markup’ language which provides methods for creating documents with headers, images, links etc. from plain text files, while keeping the original plain text file easy to read. You can convert Markdown documents to other file types like <code class="language-plaintext highlighter-rouge">.html</code> or <code class="language-plaintext highlighter-rouge">.pdf</code>.</p>

<center> <img src="/img/md_script.png" alt="Img" style="width: 900px;"> </center>

<h2 id="download-r-markdown">Download R Markdown</h2>
<p>To get R Markdown working in RStudio, the first thing you need is the <code class="language-plaintext highlighter-rouge">rmarkdown</code> package, which you can get from <a href="https://cran.r-project.org/web/packages/rmarkdown/index.html" target="_blank" rel="noopener noreferrer">CRAN</a> by running the following commands in R or RStudio:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="s2">"rmarkdown"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rmarkdown</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="the-different-parts-of-an-r-markdown-file">The different parts of an R Markdown file</h2>

<h2 id="to-make-your-markdown-file---go-to-filenew-filermarkdown">To make your Markdown file - go to <code class="language-plaintext highlighter-rouge">File/New File/RMarkdown</code>.</h2>

<h3 id="the-yaml-header">The YAML Header</h3>

<p>At the top of any R Markdown script is a <code class="language-plaintext highlighter-rouge">YAML</code> header section enclosed by <code class="language-plaintext highlighter-rouge">---</code>. By default this includes a title, author, date and the file type you want to output to. Many other options are available for different functions and formatting, see <a href="http://rmarkdown.rstudio.com/html_document_format.html" target="_blank" rel="noopener noreferrer">here for <code class="language-plaintext highlighter-rouge">.html</code> options</a> and <a href="http://rmarkdown.rstudio.com/pdf_document_format.html" target="_blank" rel="noopener noreferrer">here for <code class="language-plaintext highlighter-rouge">.pdf</code> options</a>. Rules in the header section will alter the whole document.</p>

<p>Add your own details at the top of your<code class="language-plaintext highlighter-rouge">.Rmd</code> script, e.g.:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
title: "The tidyverse in action - population change in forests"
author: Gergana Daskalova
date: 22/Oct/2016
output: html_document
---
</code></pre></div></div>

<p>By default, the <code class="language-plaintext highlighter-rouge">title</code>, <code class="language-plaintext highlighter-rouge">author</code>, <code class="language-plaintext highlighter-rouge">date</code> and <code class="language-plaintext highlighter-rouge">output</code> format are printed at the top of your <code class="language-plaintext highlighter-rouge">.html</code> document.</p>

<p>Now that we have our first piece of content, we can test the <code class="language-plaintext highlighter-rouge">.Rmd</code> file by compiling it to <code class="language-plaintext highlighter-rouge">.html</code>. To compile your <code class="language-plaintext highlighter-rouge">.Rmd</code> file into a <code class="language-plaintext highlighter-rouge">.html</code> document, you should press the <code class="language-plaintext highlighter-rouge">Knit</code> button in the taskbar:</p>

<p><img src="/img/Knit_HTML_Screenshot.jpg" alt="Img"></p>

<p>Not only does a preview appear in the <code class="language-plaintext highlighter-rouge">Viewer</code> window in RStudio, but it also saves a <code class="language-plaintext highlighter-rouge">.html</code> file to the same folder where you saved your <code class="language-plaintext highlighter-rouge">.Rmd</code> file.</p>

<p><a name="insert"></a></p>

<h3 id="code-chunks">Code Chunks</h3>

<p><strong>Have a read through the text below to learn a bit more about how Markdown works and then you can start compiling the rest of your <code class="language-plaintext highlighter-rouge">.Md</code> file.</strong></p>

<h4 id="the-setup-chunk">The setup chunk</h4>

<p><strong>This code chunk appears in <code class="language-plaintext highlighter-rouge">.Md</code> files in R by default, it won’t appear in your html or pdf document, it just sets up the document.</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
</code></pre></div></div>

<h4 id="the-rest-of-the-code-chunks">The rest of the code chunks</h4>

<p>This is where you can add your own code, accompanying explanation and any outputs. Code that is included in your <code class="language-plaintext highlighter-rouge">.Rmd</code> document should be enclosed by three backwards apostrophes <code class="language-plaintext highlighter-rouge">```</code> (grave accents!). These are known as code chunks and look like this (no need to copy this, just an example):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
norm &lt;- rnorm(100, mean = 0, sd = 1)
```
</code></pre></div></div>

<p>Inside the curly brackets is a space where you can assign rules for that code chunk. The code chunk above says that the code is R code.</p>

<p>It’s important to remember when you are creating an R Markdown file that if you want to run code that refers to an object, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
plot(dataframe)
```
</code></pre></div></div>

<p>You have to include the code that defines what <code class="language-plaintext highlighter-rouge">dataframe</code> is, just like in a normal R script. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
A &lt;- c("a", "a", "b", "b")
B &lt;- c(5, 10, 15, 20)
dataframe &lt;- data.frame(A, B)
plot(dataframe)
```
</code></pre></div></div>

<p>Or if you are loading a dataframe from a <code class="language-plaintext highlighter-rouge">.csv</code> file, you must include the code in the <code class="language-plaintext highlighter-rouge">.Rmd</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
dataframe &lt;- read.csv("~/Desktop/Code/dataframe.csv")
# Note that the file path should be whatever the file path to your own file is
```
</code></pre></div></div>

<p>Similarly, if you are using any packages in your analysis, you have to load them in the <code class="language-plaintext highlighter-rouge">.Rmd</code> file using <code class="language-plaintext highlighter-rouge">library()</code> like in a normal R script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
library(dplyr)
```
</code></pre></div></div>

<h4 id="hiding-code-chunks">Hiding code chunks</h4>

<p>If you don’t want the code of a particular code chunk to appear in the final document, but still want to show the output (e.g. a plot), then you can include <code class="language-plaintext highlighter-rouge">echo = FALSE</code> in the code chunk instructions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r, echo = FALSE}
A &lt;- c("a", "a", "b", "b")
B &lt;- c(5, 10, 15, 20)
dataframe &lt;- data.frame(A, B)
plot(dataframe)
```
</code></pre></div></div>

<p>Sometimes, you might want to create an object, but not include both the code and its output in the final <code class="language-plaintext highlighter-rouge">.html</code> file. To do this you can use, <code class="language-plaintext highlighter-rouge">include = FALSE</code>. Be aware though, when making reproducible research it’s often not a good idea to completely hide some part of your analysis:</p>

<p><strong>REMEMBER: <code class="language-plaintext highlighter-rouge">R Markdown</code> doesn’t pay attention to anything you have loaded in other R scripts, you have to load all objects and packages in the R Markdown script.</strong></p>

<p><strong>If you are keen, you can complete the rest of the workshop using an <code class="language-plaintext highlighter-rouge">R Markdown</code> document - essentially depends on your workflow - sometimes you might make a <code class="language-plaintext highlighter-rouge">Markdown</code> report, other times having your code and comments is enough.</strong></p>

<p>You can run an individual chunk of code at any time by placing your cursor inside the code chunk and selecting <code class="language-plaintext highlighter-rouge">Run -&gt; Run Current Chunk</code>:</p>

<p><img src="/img/run_sel.png" alt="Img" style="width: 900px;"></p>

<h3 id="summary-of--code-chunk-instructions">Summary of  code chunk instructions</h3>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg th{font-family:Arial, sans-serif;font-size:14px;font-weight:normal;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .tg-yw4l{vertical-align:top}
</style>

<table class="tg">
  <tr>
    <th class="tg-yw4l"><b>Rule</b></th>
    <th class="tg-yw4l">
<b>Example</b><br>(default)</th>
    <th class="tg-yw4l"><b>Function</b></th>
  </tr>
  <tr>
    <td class="tg-yw4l">eval</td>
    <td class="tg-yw4l">eval=TRUE</td>
    <td class="tg-yw4l">Is the code run and the results included in the output?</td>
  </tr>
    <tr>
    <td class="tg-yw4l">include</td>
    <td class="tg-yw4l">include=TRUE</td>
    <td class="tg-yw4l">Are the code and the results included in the output?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">echo</td>
    <td class="tg-yw4l">echo=TRUE</td>
    <td class="tg-yw4l">Is the code displayed alongside the results?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">warning</td>
    <td class="tg-yw4l">warning=TRUE</td>
    <td class="tg-yw4l">Are warning messages displayed?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">error</td>
    <td class="tg-yw4l">error=FALSE</td>
    <td class="tg-yw4l">Are error messages displayed?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">message</td>
    <td class="tg-yw4l">message=TRUE</td>
    <td class="tg-yw4l">Are messages displayed?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">tidy</td>
    <td class="tg-yw4l">tidy=FALSE</td>
    <td class="tg-yw4l">Is the code reformatted to make it look “tidy”?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">results</td>
    <td class="tg-yw4l">results="markup"</td>
    <td class="tg-yw4l">
<b> How are results treated? </b> <br> "hide" = no results <br>"asis" = results without formatting <br>"hold" = results only compiled at end of chunk (use if many commands act on one object)</td>
  </tr>
  <tr>
    <td class="tg-yw4l">cache</td>
    <td class="tg-yw4l">cache=FALSE</td>
    <td class="tg-yw4l">Are the results cached for future renders?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">comment</td>
    <td class="tg-yw4l">comment="##"</td>
    <td class="tg-yw4l">What character are comments prefaced with?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">fig.width, fig.height</td>
    <td class="tg-yw4l">fig.width=7</td>
    <td class="tg-yw4l">What width/height (in inches) are the plots?</td>
  </tr>
  <tr>
    <td class="tg-yw4l">fig.align</td>
    <td class="tg-yw4l">fig.align="left"</td>
    <td class="tg-yw4l">"left" "right" "center"</td>
  </tr>
</table>

<h2 id="inserting-figures">Inserting Figures</h2>
<p>By default, RMarkdown will place graphs by maximising their height, while keeping them within the margins of the page and maintaining aspect ratio. If you have a particularly tall figure, this can mean a really huge graph. To manually set the figure dimensions, you can insert an instruction into the curly braces:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r, fig.width = 2.5, fig.height = 7.5}
ggplot(df, aes(x = x, y = y) + geom_point()
```
</code></pre></div></div>

<h2 id="inserting-tables">Inserting Tables</h2>

<p>R Markdown can print the contents of a data frame easily by enclosing the name of the data frame in a code chunk:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
dataframe
```
</code></pre></div></div>

<p>This can look a bit messy, especially with data frames with a lot of columns. You can also use a table formatting function, e.g. <code class="language-plaintext highlighter-rouge">kable()</code> from the <code class="language-plaintext highlighter-rouge">knitr</code> package. The first argument tells kable to make a table out of the object <code class="language-plaintext highlighter-rouge">dataframe</code> and that numbers should have two significant figures. Remember to load the <code class="language-plaintext highlighter-rouge">knitr</code> package in your <code class="language-plaintext highlighter-rouge">.Rmd</code> file, if you are using the <code class="language-plaintext highlighter-rouge">kable()</code> function.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
kable(dataframe, digits = 2)
```
</code></pre></div></div>

<p>If you want a bit more control over the content of your table you can use <code class="language-plaintext highlighter-rouge">pander()</code> from the <code class="language-plaintext highlighter-rouge">pander</code> package. Imagine I want the 3rd column to appear in italics:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>```{r}
emphasize.italics.cols(3)  # Make the 3rd column italics
pander(richness_abund)  # Create the table
```
</code></pre></div></div>

<p><strong>Now that you have started your <code class="language-plaintext highlighter-rouge">Markdown</code> document, you can use that when completing the next part of the tutorial, i.e., inserting the code that follows into code chunks and then generating a report at the end of this tutorial.</strong></p>

<p><a name="tidyverse"></a></p>

<h2 id="analyse-and-visualise-data-using-the-tidyverse">Analyse and visualise data using the <code class="language-plaintext highlighter-rouge">tidyverse</code>
</h2>

<h3 id="learning-objectives">Learning Objectives</h3>

<h3 id="part-1-intro-to-the-tidyverse">PART 1: Intro to the <code class="language-plaintext highlighter-rouge">tidyverse</code>
</h3>
<h4 id="how-to-analyse-population-change-of-forest-vertebrates">How to analyse population change of forest vertebrates</h4>

<ol>
  <li>How to write a custom <code class="language-plaintext highlighter-rouge">ggplot2</code> function</li>
  <li>How to use <code class="language-plaintext highlighter-rouge">gather()</code> and <code class="language-plaintext highlighter-rouge">spread()</code> from the <code class="language-plaintext highlighter-rouge">tidyr</code> package</li>
  <li>How to parse numbers using <code class="language-plaintext highlighter-rouge">parse_number()</code> from the <code class="language-plaintext highlighter-rouge">readr</code> package</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">distinct()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code>
</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">filter()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code>
</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">mutate()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code>
</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">summarise()</code>/<code class="language-plaintext highlighter-rouge">summarize()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code>
</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">tidy()</code> function from the <code class="language-plaintext highlighter-rouge">broom</code> package to summarise model results</li>
  <li>How to use the <code class="language-plaintext highlighter-rouge">select()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code>
</li>
</ol>

<p><b>In this tutorial, we will focus on how to efficiently format, manipulate and visualise large datasets. We will use the <code class="language-plaintext highlighter-rouge">tidyr</code> and <code class="language-plaintext highlighter-rouge">dplyr</code> packages to clean up data frames and calculate new variables. We will use the <code class="language-plaintext highlighter-rouge">broom</code> and <code class="language-plaintext highlighter-rouge">purr</code> packages to make the modelling of thousands of population trends more efficient. We will use the <code class="language-plaintext highlighter-rouge">ggplot2</code> package to make graphs, maps of occurrence records, and to visualise ppulation trends and then we will arrange all of our graphs together using the <code class="language-plaintext highlighter-rouge">gridExtra</code> package.</b></p>

<p>We will be working with population data from the <a href="http://www.livingplanetindex.org/home/index" target="_blank" rel="noopener noreferrer">Living Planet Database</a> and red deer occurrence data from the <a href="http://www.gbif.org/" target="_blank" rel="noopener noreferrer">Global Biodiversity Information Facility</a>, both of which are publicly available datasets.</p>

<p><strong>First, we will model population change for vertebrate forest species to see whether greater population change is found for longer duration studies.</strong></p>

<p><strong>Make sure you have set the working directory to where you saved your files.</strong></p>

<p>Here are the packages we need. Note that not all <code class="language-plaintext highlighter-rouge">tidyverse</code> packages load automatically with <code class="language-plaintext highlighter-rouge">library(tidyverse)</code> -  only the core ones do, so you need to load <code class="language-plaintext highlighter-rouge">broom</code> separately. If you don’t have some of the packages installed, you can install them using <code class="language-plaintext highlighter-rouge">ìnstall.packages("package-name")</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Packages ----</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">  </span><span class="c1"># Hadley Wickham's tidyverse - the theme of this tutorial</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">broom</span><span class="p">)</span><span class="w">  </span><span class="c1"># To summarise model outputs</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggExtra</span><span class="p">)</span><span class="w">  </span><span class="c1"># To make pretty graphs - addon package to ggplot2</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span><span class="w">  </span><span class="c1"># To make pretty maps - warning: maps masks map from purr!</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RColorBrewer</span><span class="p">)</span><span class="w">  </span><span class="c1"># To make pretty colours</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span><span class="w">  </span><span class="c1"># To arrange multi-plot panels</span><span class="w">
</span></code></pre></div></div>

<p>If you’ve ever tried to perfect your <code class="language-plaintext highlighter-rouge">ggplot2</code> graphs, you might have noticed that the lines starting with <code class="language-plaintext highlighter-rouge">theme()</code> quickly pile up: you adjust the font size of the axes and the labels, the position of the title, the background colour of the plot, you remove the grid lines in the background, etc. And then you have to do the same for the next plot, which really increases the amount of code you use. Here is a simple solution: create a customised theme that combines all the <code class="language-plaintext highlighter-rouge">theme()</code> elements you want and apply it to your graphs to make things easier and increase consistency. You can include as many elements in your theme as you want, as long as they don’t contradict one another and then when you apply your theme to a graph, only the relevant elements will be considered - e.g. for our graphs we won’t need to use <code class="language-plaintext highlighter-rouge">legend.position</code>, but it’s fine to keep it in the theme in case any future graphs we apply it to do have the need for legends.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Setting a custom ggplot2 function ---</span><span class="w">
</span><span class="c1"># *** Functional Programming ***</span><span class="w">
</span><span class="c1"># This function makes a pretty ggplot theme</span><span class="w">
</span><span class="c1"># This function takes no arguments!</span><span class="w">
</span><span class="n">theme_LPD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(){</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="o">+</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w">
          </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">),</span><span class="w">
          </span><span class="n">axis.title.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"plain"</span><span class="p">),</span><span class="w">             
          </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"plain"</span><span class="p">),</span><span class="w">             
          </span><span class="n">panel.grid.major.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">                                          
          </span><span class="n">panel.grid.minor.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
          </span><span class="n">panel.grid.minor.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
          </span><span class="n">panel.grid.major.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">  
          </span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="s2">"cm"</span><span class="p">),</span><span class="w">
          </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w">
          </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"italic"</span><span class="p">),</span><span class="w">          
          </span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">                              
          </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.8</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="load-population-trend-data">Load population trend data</h4>

<p><strong>The data are in a <code class="language-plaintext highlighter-rouge">.RData</code> format, as those are quicker to use, since <code class="language-plaintext highlighter-rouge">.Rdata</code> files are more compressed. Of course, a drawback is that <code class="language-plaintext highlighter-rouge">.RData</code> files can only be used within R, whereas <code class="language-plaintext highlighter-rouge">.csv</code> files are more transferable.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load data ----</span><span class="w">
</span><span class="n">load</span><span class="p">(</span><span class="s2">"LPDdata_Feb2016.RData"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Inspect data ----</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">LPDdata_Feb2016</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/wide.png" alt="Img" style="width: 600px;"> </center>

<p>At the moment, each row contains a population that has been monitored over time and towards the right of the data frame there are lots of columns with population estimates for each year. To make this data “tidy” (one column per variable) we can use <code class="language-plaintext highlighter-rouge">gather()</code> to transform the data so there is a new column containing all the years for each population and an adjacent column containing all the population estimates for those years.</p>

<p>This takes our original dataset <code class="language-plaintext highlighter-rouge">LPIdata_Feb2016</code> and creates a new column called <code class="language-plaintext highlighter-rouge">year</code>, fills it with column names from columns <code class="language-plaintext highlighter-rouge">26:70</code> and then uses the data from these columns to make another column called <code class="language-plaintext highlighter-rouge">pop</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Format data for analysis ----</span><span class="w">

</span><span class="c1"># Transform from wide to long format usign gather (opposite is spread)</span><span class="w">
</span><span class="c1"># *** gather() function from the dplyr package in the tidyverse ***</span><span class="w">
</span><span class="n">LPD_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gather</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LPDdata_Feb2016</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"year"</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pop"</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">26</span><span class="o">:</span><span class="m">70</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Because column names are coded in as characters, when we turned the column names (<code class="language-plaintext highlighter-rouge">1970</code>, <code class="language-plaintext highlighter-rouge">1971</code>, <code class="language-plaintext highlighter-rouge">1972</code>, etc.) into rows, R automatically put an <code class="language-plaintext highlighter-rouge">X</code> in front of the numbers to force them to remain characters. We don’t want that, so to turn <code class="language-plaintext highlighter-rouge">year</code> into a numeric variable, use the <code class="language-plaintext highlighter-rouge">parse_number()</code> function from the <code class="language-plaintext highlighter-rouge">readr</code> package. We can also make all the column names lowercase and remove some of the funky characters in the country column - strange characters mess up things in general, e.g. when you want to save files, push them to GitHub, etc.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get rid of the X in front of years</span><span class="w">
</span><span class="c1"># *** parse_number() from the readr package in the tidyverse ***</span><span class="w">
</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">year</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">parse_number</span><span class="p">(</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">year</span><span class="p">)</span><span class="w">

</span><span class="c1"># Rename variable names for consistency</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">LPD_long</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">LPD_long</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tolower</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">LPD_long</span><span class="p">))</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">LPD_long</span><span class="p">)</span><span class="w">

</span><span class="c1"># Create new column with genus and species together</span><span class="w">
</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">species.name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">genus</span><span class="p">,</span><span class="w"> </span><span class="n">LPD_long</span><span class="o">$</span><span class="n">species</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">" "</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get rid of strange characters like " / "</span><span class="w">
</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">country.list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">LPD_long</span><span class="o">$</span><span class="n">country.list</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">LPD_long</span><span class="o">$</span><span class="n">biome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">LPD_long</span><span class="o">$</span><span class="n">biome</span><span class="p">,</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Examine the tidy data frame</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">LPD_long</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/long.png" alt="Img" style="width: 600px;"> </center>

<p>Now that our dataset is <em>tidy</em> we can get it ready for our analysis. We want to only use populations that have more than 5 years of data to make sure our analysis has enough data to capture population change. We should also scale the population data, because since the data come from many species, the units and magnitude of the data are very different - imagine tiny fish whose abundance is in the millions, and large carnivores whose abundance is much smaller. Scaling also normalises the data, as later on we will be using linear models assuming a normal distribution. To do all of this in one go, we can use pipes.</p>

<p><strong>Pipes (<code class="language-plaintext highlighter-rouge">%&gt;%</code>) are a way of streamlining data manipulation - imagine all of your data coming in one end of the pipe, while they are in there, they are manipulated, summarised, etc., then the output (e.g. your new data frame or summary statistics) comes out the other end of the pipe. At each step of the pipe processing, the pipe is using the ouput of the previous step.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Data manipulation ----</span><span class="w">

</span><span class="c1"># *** piping from from dplyr</span><span class="w">
</span><span class="n">LPD_long2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">LPD_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Remove duplicate rows</span><span class="w">
  </span><span class="c1"># *** distinct() function from dplyr</span><span class="w">
  </span><span class="n">distinct</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># remove NAs in the population column</span><span class="w">
  </span><span class="c1"># *** filter() function from dplyr</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Group rows so that each group is one population</span><span class="w">
  </span><span class="c1"># *** group_by() function from dplyr</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">  
  </span><span class="c1"># Make some calculations</span><span class="w">
  </span><span class="c1"># *** mutate() function from dplyr</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">maxyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="w"> </span><span class="n">minyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">year</span><span class="p">),</span><span class="w">
         </span><span class="c1"># Calculate duration</span><span class="w">
         </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxyear</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">minyear</span><span class="p">,</span><span class="w">
         </span><span class="c1"># Scale population trend data</span><span class="w">
         </span><span class="n">scalepop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">pop</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">pop</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Keep populations with &gt;5 years worth of data and calculate length of monitoring</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="nf">is.finite</span><span class="p">(</span><span class="n">scalepop</span><span class="p">),</span><span class="w">
         </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">year</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Remove any groupings you've greated in the pipe</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>Now we can explore our data a bit. Let’s create a few basic summary statistics for each biome and store them in a new data frame:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate summary statistics for each biome</span><span class="w">
</span><span class="n">LPD_biome_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">LPD_long2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Group by biome</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">biome</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create columns, number of populations</span><span class="w">
  </span><span class="c1">#  *** summarise()/summarize() function from dplyr in the tidyverse ***</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">populations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">(),</span><span class="w">   
            </span><span class="c1"># Calculate the mean study length</span><span class="w">
            </span><span class="n">mean_study_length_years</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span><span class="w">
            </span><span class="c1"># Model sampling method</span><span class="w">
            </span><span class="n">dominant_sampling_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">which.max</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">sampling.method</span><span class="p">))),</span><span class="w">
            </span><span class="c1"># Model unit type</span><span class="w">
            </span><span class="n">dominant_units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">which.max</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">units</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Remove any groupings you've created in the pipe</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">

</span><span class="c1"># Take a look at some of the records</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">LPD_biome_sum</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Next we will explore how populations from two of these biomes, temperate coniferous and temperate broadleaf forests, have changed over the monitoring duration. We will make the <code class="language-plaintext highlighter-rouge">biome</code> variable a factor (before it is just a character variable), so that later on we can make graphs based on the two categories (coniferous and broadleaf forests). We’ll use the <code class="language-plaintext highlighter-rouge">filter()</code> function from <code class="language-plaintext highlighter-rouge">dplyr</code> to subset the data to just the forest species.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Subset to just temperate forest species -----
  # Notice the difference between | and &amp; when filtering
  # | is an "or" whereas &amp; is "and", i.e. both conditions have to be met
  # at the same time
LPD_long2$biome &lt;- as.factor(LPD_long2$biome)
LPD.forest &lt;- filter(LPD_long2, biome == "Temperate broadleaf and mixed forests" |
                                      biome == "Temperate coniferous forests")
</code></pre></div></div>

<p>Before running models, it’s a good idea to visualise our data to explore what kind of distribution we are working with.</p>

<p>The <code class="language-plaintext highlighter-rouge">gg</code> in <code class="language-plaintext highlighter-rouge">ggplot2</code> stands for grammar of graphics. Writing the code for your graph is like constructing a sentence made up of different parts that logically follow from one another. In a data visualisation context, the different elements of the code represent layers - first you make an empty plot, then you add a layer with your data points, then your measure of uncertainty, the axis labels and so on.</p>

<p><b> When using <code class="language-plaintext highlighter-rouge">ggplot2</code>, you usually start your code with <code class="language-plaintext highlighter-rouge">ggplot(your_data, aes(x = independent_variable, y = dependent_variable))</code>, then you add the type of plot you want to make using <code class="language-plaintext highlighter-rouge">+ geom_boxplot()</code>, <code class="language-plaintext highlighter-rouge">+ geom_histogram()</code>, etc. <code class="language-plaintext highlighter-rouge">aes</code> stands for aesthetics, hinting to the fact that using <code class="language-plaintext highlighter-rouge">ggplot2</code> you can make aesthetically pleasing graphs - there are many <code class="language-plaintext highlighter-rouge">ggplot2</code> functions to help you clearly communicate your results, and we will now go through some of them.</b></p>

<p><b>When we want to change the colour, shape or fill of a variable based on another variable, e.g. colour-code by species, we include <code class="language-plaintext highlighter-rouge">colour = species</code> inside the <code class="language-plaintext highlighter-rouge">aes()</code> function. When we want to set a specific colour, shape or fill, e.g. <code class="language-plaintext highlighter-rouge">colour = "black"</code>, we put that outside of the <code class="language-plaintext highlighter-rouge">aes()</code> function.</b></p>

<p>We will see our custom theme <code class="language-plaintext highlighter-rouge">theme_LPD()</code> in action as well!</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Data visualisation ----</span><span class="w">
</span><span class="c1"># Data distribution - a histogram</span><span class="w">
</span><span class="p">(</span><span class="n">forest.hist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">LPD.forest</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scalepop</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biome</span><span class="p">),</span><span class="w">
                  </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"identity"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey40"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">scalepop</span><span class="p">)),</span><span class="w">  </span><span class="c1"># Adding a line for mean abundance</span><span class="w">
              </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkred"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dashed"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#66CD00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#53868B"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a) Data distribution\n"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\nScaled population size"</span><span class="p">,</span><span class="w">
        </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Count\n"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="c1"># \n adds a blank line</span><span class="w">
   </span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="c1"># Hiding the legend - this will be a two plot panel</span><span class="w">
</span><span class="c1"># thus we don't need the same legend twice</span><span class="w">
</span></code></pre></div></div>

<p>Next up we can explore for how long populations have been monitored in the two biomes using a density histogram.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Density histogram of duration of studies in the two biomes</span><span class="w">
</span><span class="p">(</span><span class="n">duration.forests</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">LPD.forest</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">biome</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">stat_density</span><span class="p">(</span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"line"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">scale_colour_manual</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"#66CD00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"#53868B"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
   </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"\nYears"</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Density\n"</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"b) Monitoring duration\n"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>We’ll use the <code class="language-plaintext highlighter-rouge">grid.arrange</code> function from the <code class="language-plaintext highlighter-rouge">gridExtra</code> package to combine the two plots in a panel. You can specify the number of columns using <code class="language-plaintext highlighter-rouge">ncol =</code> and the number of rows using <code class="language-plaintext highlighter-rouge">nrow =</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Arrange in a panel and save</span><span class="w">
</span><span class="n">forest.panel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">forest.hist</span><span class="p">,</span><span class="w"> </span><span class="n">duration.forests</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">ggsave</span><span class="p">(</span><span class="n">forest.panel</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"forest_panel.png"</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/forest_panel.png" alt="Img" style="width: 900px;"> </center>

<p>We are now ready to model how each population has changed over time. There are 1785 populations, so with this one code chunk, we will run 1785 models and tidy up their outputs. You can read through the line-by-line comments to get a feel for what each line of code is doing.</p>

<p><strong>One specific thing to note is that when you add the <code class="language-plaintext highlighter-rouge">lm()</code> function in a pipe, you have to add <code class="language-plaintext highlighter-rouge">data = .</code>, which means use the outcome of the previous step in the pipe for the model.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate population change for each forest population</span><span class="w">
</span><span class="c1"># 1785 models in one go!</span><span class="w">
</span><span class="c1"># Using a pipe</span><span class="w">
</span><span class="n">forest.slopes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">LPD.forest</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Group by the key variables that we want to iterate over</span><span class="w">
  </span><span class="c1"># note that if we only include e.g. id (the population id), then we only get the</span><span class="w">
  </span><span class="c1"># id column in the model summary, not e.g. duration, latitude, class...</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">decimal.latitude</span><span class="p">,</span><span class="w"> </span><span class="n">decimal.longitude</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="p">,</span><span class="w"> 
           </span><span class="n">species.name</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">location.of.population</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Create a linear model for each group</span><span class="w">
  </span><span class="n">do</span><span class="p">(</span><span class="n">mod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lm</span><span class="p">(</span><span class="n">scalepop</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Extract model coefficients using tidy() from the</span><span class="w">
  </span><span class="c1"># *** tidy() function from the broom package ***</span><span class="w">
  </span><span class="n">tidy</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Filter out slopes and remove intercept values</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">term</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"year"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Get rid of the column term as we don't need it any more</span><span class="w">
  </span><span class="c1">#  *** select() function from dplyr in the tidyverse ***</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="c1"># Remove any groupings you've greated in the pipe</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>We are ungrouping at the end of our pipe just because otherwise the object remains grouped and later on that might cause problems, if we forget about it.</p>

<p><strong>Now we can visualise the outputs of all our models and see how they vary based on study duration. We will add density histograms along the margins of the graph which makes for a more informative graph using the <code class="language-plaintext highlighter-rouge">ggMarginal()</code> function from the <code class="language-plaintext highlighter-rouge">ggExtra</code> package. Note that <code class="language-plaintext highlighter-rouge">ggExtra</code> is also an addin in <code class="language-plaintext highlighter-rouge">RStudio</code>, so for future reference, if you select some <code class="language-plaintext highlighter-rouge">ggplot2</code> code, then click on <code class="language-plaintext highlighter-rouge">Addins/ggplot2 Marginal plots</code> (the menu is in the middle top part of the screen), you can customise marginal histograms and the code gets automatically generated.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Visualising model outputs ----</span><span class="w">

</span><span class="c1"># Plotting slope estimates and standard errors for all populations and adding histograms along the margins</span><span class="w">
</span><span class="p">(</span><span class="n">all.slopes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">forest.slopes</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
         </span><span class="n">geom_pointrange</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">std.error</span><span class="p">,</span><span class="w">
                             </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std.error</span><span class="p">),</span><span class="w">
                         </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
         </span><span class="n">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dashed"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
         </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
         </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Population change\n"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
         </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"\nDuration (years)"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="n">density.slopes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggExtra</span><span class="o">::</span><span class="n">ggMarginal</span><span class="p">(</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">all.slopes</span><span class="p">,</span><span class="w">
  </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'density'</span><span class="p">,</span><span class="w">
  </span><span class="n">margins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'both'</span><span class="p">,</span><span class="w">
  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">
  </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'gray40'</span><span class="p">,</span><span class="w">
  </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'gray'</span><span class="w">
</span><span class="p">))</span><span class="w">

</span><span class="c1"># Save the plot</span><span class="w">
</span><span class="n">ggsave</span><span class="p">(</span><span class="n">density.slopes</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"slopes_duration.png"</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/slopes_duration.png" alt="Img" style="width: 600px;"> </center>

<p><a name="pipes"></a></p>

<h3 id="part-2-using-pipes-to-make-figures-with-large-datasets">PART 2: Using pipes to make figures with large datasets</h3>
<p>How to print plots of population change for multiple taxa</p>

<ol>
  <li>How to set up file paths and folders in R</li>
  <li>How to use a pipe to plot many plots by taxa</li>
  <li>How to use the purrr package and functional programming</li>
</ol>

<p><strong>In the next part of the tutorial, we will focus on automating iterative actions, for example when we want to create the same type of graph for different subsets of our data. In our case, we will make histograms of the population change experienced by different vertebrate taxa in forests. When making multiple graphs at once, we have to specify the folder where they will be saved first.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># PART 2: Using pipes to make figures with large datasets ----</span><span class="w">

</span><span class="c1"># Make histograms of slope estimates for each taxa -----</span><span class="w">
</span><span class="c1"># Set up new folder for figures</span><span class="w">
</span><span class="c1"># Set path to relevant path on your computer/in your repository</span><span class="w">
</span><span class="n">path1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Taxa_Forest_LPD/"</span><span class="w">
</span><span class="c1"># Create new folder</span><span class="w">
</span><span class="n">dir.create</span><span class="p">(</span><span class="n">path1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>There isn’t a right answer here, there are different ways to achieve the same result and you can decide which one works best for your workflow. First we will use <code class="language-plaintext highlighter-rouge">dplyr</code> and pipes <code class="language-plaintext highlighter-rouge">%&gt;%</code>. Since we want one graph per taxa, we are going to group by the <code class="language-plaintext highlighter-rouge">class</code> variable. You can add functions that are not part of the <code class="language-plaintext highlighter-rouge">dplyr</code> package to pipes using <code class="language-plaintext highlighter-rouge">do</code> - in our case, we are saying that we want <code class="language-plaintext highlighter-rouge">R</code> to do our requested action (making and saving the histograms) for each taxa.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First we will do this using dplyr and a pipe</span><span class="w">

</span><span class="n">forest.slopes</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="c1"># Select the relevant data</span><span class="w">
</span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">species.name</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="c1"># Group by taxa</span><span class="w">
</span><span class="n">group_by</span><span class="p">(</span><span class="n">class</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
</span><span class="c1"># Save all plots in new folder</span><span class="w">
</span><span class="n">do</span><span class="p">(</span><span class="n">ggsave</span><span class="p">(</span><span class="n">ggplot</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">estimate</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
            </span><span class="c1"># Add histograms</span><span class="w">
            </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.02</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
            </span><span class="c1"># Use custom theme</span><span class="w">
            </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
            </span><span class="c1"># Add axis lables</span><span class="w">
            </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Rate of population change (slopes)"</span><span class="p">),</span><span class="w">
            </span><span class="c1"># Set up file names to print to</span><span class="w">
            </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsub</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">.</span><span class="o">$</span><span class="n">class</span><span class="p">)),</span><span class="w">
                                          </span><span class="s2">".pdf"</span><span class="p">)),</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"pdf"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>A warning message pops up: <code class="language-plaintext highlighter-rouge">Error: Results 1, 2, 3, 4 must be data frames, not NULL</code> - you can ignore this, it’s because the <code class="language-plaintext highlighter-rouge">do()</code> function expects a data frame as an output, but in our case we are making graphs, not data frames.</p>

<p>If you go check out your folder now, you should see four histograms, one per taxa:</p>
<center> <img src="/img/folder.png" alt="Img" style="width: 500px;"> <img src="/img/mamm.png" alt="Img" style="width: 500px;"> </center>

<p>Another way to make all those histograms in one go is by creating a function for it. In general, whenever you find yourself copying and pasting lots of code only to change the object name, you’re probably in a position to swap all the code with a function - you can then apply the function using the <code class="language-plaintext highlighter-rouge">purrr</code> package.</p>

<p>But what is <code class="language-plaintext highlighter-rouge">purrr</code>? <strong>It is a way to “map” or “apply” functions to data. Note that there are functions from other packages also called <code class="language-plaintext highlighter-rouge">map()</code>, which is why we are specifying we want the <code class="language-plaintext highlighter-rouge">map()</code> function from the <code class="language-plaintext highlighter-rouge">purrr</code> package. Here we will first format the data <code class="language-plaintext highlighter-rouge">taxa.slopes</code> and then we will map it to the mean fuction:</strong></p>

<p>We have to change the format of the data, in our case we will split the data using <code class="language-plaintext highlighter-rouge">spread()</code> from the <code class="language-plaintext highlighter-rouge">tidyr</code> package.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Here we select the relevant data</span><span class="w">
</span><span class="c1"># Let's get rid of the other levels of 'class'</span><span class="w">
</span><span class="n">forest.slopes</span><span class="o">$</span><span class="n">class</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">forest.slopes</span><span class="o">$</span><span class="n">class</span><span class="p">)</span><span class="w">
</span><span class="c1"># Selecting the relevant data and splitting it into a list</span><span class="w">
</span><span class="n">taxa.slopes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forest.slopes</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">spread</span><span class="p">(</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="n">estimate</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>We can apply the <code class="language-plaintext highlighter-rouge">mean</code> function using <code class="language-plaintext highlighter-rouge">purrr::map()</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxa.mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">purrr</span><span class="o">::</span><span class="n">map</span><span class="p">(</span><span class="n">taxa.slopes</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">mean</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w">
</span><span class="c1"># Note that we have to specify "."</span><span class="w">
</span><span class="c1"># so that the function knows to use our taxa.slopes object</span><span class="w">
</span><span class="c1"># This plots the mean population change per taxa</span><span class="w">
</span><span class="n">taxa.mean</span><span class="w">
</span></code></pre></div></div>

<p>Now we can write our own function to make histograms and use the <code class="language-plaintext highlighter-rouge">purrr</code> package to apply it to each taxa.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### Intro to the purrr package ----</span><span class="w">

</span><span class="c1"># First let's write a function to make the plots</span><span class="w">
</span><span class="c1"># *** Functional Programming ***</span><span class="w">
</span><span class="c1"># This function takes one argument x, the data vector that we want to make a histogram</span><span class="w">
</span><span class="n">plot.hist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">binwidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.02</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Rate of population change (slopes)"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Now we can use purr to “map” our figure making function. The first input is your data that you want to iterate over and the second input is the function.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">taxa.plots</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">purrr</span><span class="o">::</span><span class="n">map</span><span class="p">(</span><span class="n">taxa.slopes</span><span class="p">,</span><span class="w"> </span><span class="o">~</span><span class="n">plot.hist</span><span class="p">(</span><span class="n">.</span><span class="p">))</span><span class="w">
</span><span class="c1"># We need to make a new folder to put these figures in</span><span class="w">
</span><span class="n">path2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Taxa_Forest_LPD_purrr/"</span><span class="w">
</span><span class="n">dir.create</span><span class="p">(</span><span class="n">path2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><strong>First we learned about <code class="language-plaintext highlighter-rouge">map()</code> when there is one dataset, but there are other <code class="language-plaintext highlighter-rouge">purrr</code> functions,too.
<code class="language-plaintext highlighter-rouge">walk2()</code> takes two arguments and returns nothing. In our case we just want to print the graphs, so we don’t need anything returned. The first argument is our file path, the second is our data and ggsave is our function.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># *** walk2() function in purrr from the tidyverse ***</span><span class="w">
</span><span class="n">walk2</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">path2</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">taxa.slopes</span><span class="p">),</span><span class="w"> </span><span class="s2">".pdf"</span><span class="p">),</span><span class="w"> </span><span class="n">taxa.plots</span><span class="p">,</span><span class="w"> </span><span class="n">ggsave</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><a name="mapping"></a></p>

<h3 id="part-3-downloading-and-mapping-data-from-large-datasets">PART 3: Downloading and mapping data from large datasets</h3>
<h4 id="map-the-distribution-of-a-forest-vertebrate-species-and-the-location-of-monitored-populations">Map the distribution of a forest vertebrate species and the location of monitored populations</h4>

<ol>
  <li>How to download GBIF records</li>
  <li>How to map occurence data and populations</li>
  <li>How to make a custom function for plotting figures</li>
</ol>

<p><strong>In this part of the tutorial, we will focus on one particular species, red deer (<em>Cervus elaphus</em>), where it has been recorded around the world, and where it’s populations are being monitored. We will use occurrence data from the <a href="http://www.gbif.org/" target="_blank" rel="noopener noreferrer">Global Biodiversity Information Facility</a> which we will download in <code class="language-plaintext highlighter-rouge">R</code> using the <code class="language-plaintext highlighter-rouge">rgbif</code> package.</strong></p>

<p>Occurrence data can be messy and when you are working with thousands of records, not all of them might be valid records. If you are keen to find out how to test the validity of geographic coordinates using the <code class="language-plaintext highlighter-rouge">CoordinateCleaner</code> package, check out our tutorial <a href="https://ourcodingclub.github.io/2018/01/06/occurrence.html" target="_blank" rel="noopener noreferrer">here</a>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### PART 3: Downloading and mapping data from large datasets ----</span><span class="w">
</span><span class="c1">#### How to map distributions and monitoring locations for one or more taxa</span><span class="w">

</span><span class="c1"># Packages ----</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rgbif</span><span class="p">)</span><span class="w">  </span><span class="c1"># To extract GBIF data</span><span class="w">
</span><span class="c1"># library(CoordinateCleaner)  # To clean coordinates if you want to explore that later</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span><span class="w">  </span><span class="c1"># To make pretty graphs</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggrepel</span><span class="p">)</span><span class="w">  </span><span class="c1"># To add labels with rounded edges</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">png</span><span class="p">)</span><span class="w">  </span><span class="c1"># To add icons</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">mapdata</span><span class="p">)</span><span class="w">  </span><span class="c1"># To plot maps</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggthemes</span><span class="p">)</span><span class="w">  </span><span class="c1"># To make maps extra pretty</span><span class="w">
</span></code></pre></div></div>

<p>We are limiting the number of records to 5000 for the sake of time - in the future you can ask for more records as well, there’s just a bit of waiting involved. The records come with a lot of metadata. For our purposes, we will select just the columns we need. Similar to how before we had to specify that we want the <code class="language-plaintext highlighter-rouge">map()</code> function from the <code class="language-plaintext highlighter-rouge">purrr</code> package, there are often other <code class="language-plaintext highlighter-rouge">select()</code> functions, so we are saying that we want the one from <code class="language-plaintext highlighter-rouge">dplyr</code> using <code class="language-plaintext highlighter-rouge">dplyr::select()</code>. Otherwise, the <code class="language-plaintext highlighter-rouge">select()</code> function might not work because of a conflict with another <code class="language-plaintext highlighter-rouge">select()</code> function from a different package, e.g. the <code class="language-plaintext highlighter-rouge">raster</code> packge.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Download species occurrence records from the Global Biodiversity Information Facility</span><span class="w">
</span><span class="c1"># *** rgbif package and the occ_search() function ***</span><span class="w">
</span><span class="c1"># You can increase the limit to get more records - 10000 takes a couple of minutes</span><span class="w">
</span><span class="n">deer.locations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">occ_search</span><span class="p">(</span><span class="n">scientificName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Cervus elaphus"</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10000</span><span class="p">,</span><span class="w">
                             </span><span class="n">hasCoordinate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"data"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
                  </span><span class="c1"># Simplify occurrence data frame</span><span class="w">
                  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">decimalLongitude</span><span class="p">,</span><span class="w">
		                </span><span class="n">decimalLatitude</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w">
				</span><span class="n">individualCount</span><span class="p">,</span><span class="w"> </span><span class="n">country</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Next we will extract the red deer population data - the raw time series and the slopes of population change from the two data frames.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Data formatting &amp; manipulation ----</span><span class="w">

</span><span class="c1"># Filter out population data for chosen species - red deer</span><span class="w">
</span><span class="n">deer.data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">LPD_long2</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">species.name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Cervus elaphus"</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">dplyr</span><span class="o">::</span><span class="n">select</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">species.name</span><span class="p">,</span><span class="w"> </span><span class="n">location.of.population</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">pop</span><span class="p">)</span><span class="w">

</span><span class="c1"># Filter out population estimates for chosen species - red deer</span><span class="w">
</span><span class="n">deer.slopes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">forest.slopes</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">species.name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Cervus elaphus"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><strong>In addition to making histograms, scatterplots and such, you can use <code class="language-plaintext highlighter-rouge">ggplot2</code> to make maps as well - the maps come from the <code class="language-plaintext highlighter-rouge">mapdata</code> package we loaded earlier. In this map, we want to visualise information from two separate data frames - where the species occurs (<code class="language-plaintext highlighter-rouge">deer.locations</code>, the GBIF data) and where it is monitored (<code class="language-plaintext highlighter-rouge">deer.slopes</code>, the Living Planet Database data). We can combine this information in the same <code class="language-plaintext highlighter-rouge">ggplot2</code> code chunk using the <code class="language-plaintext highlighter-rouge">geom_point()</code> function twice - the first time it will plot the occurrences since that the data frame associated with the plot in the very first line, and the second time we’ve told the function to specifically use the <code class="language-plaintext highlighter-rouge">deer.slopes</code> object using <code class="language-plaintext highlighter-rouge">data = deer.slopes</code>.</strong></p>

<p>As you start making your maps, you may get this warning message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning message:
In drawGrob(x) : reached elapsed time limit
</code></pre></div></div>

<p>We are working with thousands of records, so depending on your computer, making the map might take a while. This message doesn’t mean something is wrong, just lets you know that generating the map took a bit longer than what <code class="language-plaintext highlighter-rouge">RStudio</code> expected.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make an occurrence map and include the locations of the populations part of the Living Planet Database</span><span class="w">
</span><span class="p">(</span><span class="n">deer.map.LPD</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">deer.locations</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimalLongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimalLatitude</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Add map data</span><span class="w">
    </span><span class="n">borders</span><span class="p">(</span><span class="s2">"world"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gray80"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gray80"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Use custom map theme from ggthemes package</span><span class="w">
    </span><span class="n">theme_map</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Add the points from the population change data</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Specify where the data come from when plotting from more than one data frame using data = ""</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deer.slopes</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.latitude</span><span class="p">),</span><span class="w">
               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/deer_map.png" alt="Img" style="width: 900px;"> </center>

<p>The map already looks fine, but we can customise it further to add more information. For example, we can add labels for the locations of some of the monitored populations and we can add plots of population change next to our map.</p>

<p>First we will rename some of the populations, just so that our labels are not crazy long, using the <code class="language-plaintext highlighter-rouge">recode()</code> function from the <code class="language-plaintext highlighter-rouge">dplyr</code> package.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Customising map to make it more beautiful ----</span><span class="w">

</span><span class="c1"># Check site names</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">)</span><span class="w">

</span><span class="c1"># Beautify site names</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Northern Yellowstone National Park"</span><span class="w">
					     </span><span class="o">=</span><span class="w"> </span><span class="s2">"Yellowstone National Park"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Mount Rainier National Park, USA"</span><span class="w">
					     </span><span class="o">=</span><span class="w"> </span><span class="s2">"Mount Rainier National Park"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Bow Valley - eastern zone, Banff National Park, Alberta"</span><span class="w"> </span><span class="o">=</span><span class="w">
					     </span><span class="s2">"Banff National Park, Alberta"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Bow Valley - western zone, Banff National Park, Alberta"</span><span class="w"> </span><span class="o">=</span><span class="w">
					     </span><span class="s2">"Banff National Park, Alberta"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Bow Valley - central zone, Banff National Park, Alberta"</span><span class="w"> </span><span class="o">=</span><span class="w">
					     </span><span class="s2">"Banff National Park, Alberta"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Study area within Bow Valley, Banff National Park, Alberta"</span><span class="w"> </span><span class="o">=</span><span class="w">
					     </span><span class="s2">"Banff National Park, Alberta"</span><span class="p">)</span><span class="w">
</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recode</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">,</span><span class="w">
                                             </span><span class="s2">"Bow Valley watershed of Banff National Park, Alberta"</span><span class="w"> </span><span class="o">=</span><span class="w">
					     </span><span class="s2">"Banff National Park, Alberta"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>You can also use <code class="language-plaintext highlighter-rouge">ggplot2</code> to add images to your graphs, so here we will add a deer icon.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load packages for adding images</span><span class="w">
</span><span class="n">packs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"png"</span><span class="p">,</span><span class="s2">"grid"</span><span class="p">)</span><span class="w">
</span><span class="n">lapply</span><span class="p">(</span><span class="n">packs</span><span class="p">,</span><span class="w"> </span><span class="n">require</span><span class="p">,</span><span class="w"> </span><span class="n">character.only</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Load red deer icon</span><span class="w">
</span><span class="n">icon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readPNG</span><span class="p">(</span><span class="s2">"reddeer.png"</span><span class="p">)</span><span class="w">
</span><span class="n">icon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rasterGrob</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>We can update our map by adding labels and our icon - this looks like a gigantic chunk of code, but we’ve added line by line comments so that you can see what’s happening at each step. The <code class="language-plaintext highlighter-rouge">ggrepel</code> package adds labels whilst also aiming to avoid overlap and as a bonus, the labels have rounded edges.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Update map</span><span class="w">
</span><span class="c1"># Note - this takes a while depending on your computer</span><span class="w">
</span><span class="p">(</span><span class="n">deer.map.final</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">deer.locations</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimalLongitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimalLatitude</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># For more localized maps use "worldHires" instead of "world"</span><span class="w">
    </span><span class="n">borders</span><span class="p">(</span><span class="s2">"world"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gray80"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"gray80"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme_map</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># We are specifying the data frame for the labels - one site has three monitored populations</span><span class="w">
    </span><span class="c1"># but we only want to label it once so we are subsetting using data = deer.slopes[c(2, 4, 5, 9),]</span><span class="w">
    </span><span class="c1"># to get only the first rows number 2, 4, 5 and 9</span><span class="w">
    </span><span class="n">geom_label_repel</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deer.slopes</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">9</span><span class="p">),],</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.latitude</span><span class="p">,</span><span class="w">
                                                     </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">location.of.population</span><span class="p">),</span><span class="w">
                     </span><span class="n">box.padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">nudge_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                     </span><span class="c1"># We are specifying the size of the labels and nudging the points so that they</span><span class="w">
                     </span><span class="c1"># don't hide data points, along the x axis we are nudging by one</span><span class="w">
                     </span><span class="n">min.segment.length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">inherit.aes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># We can recreate the shape of a dropped pin by overlaying a circle and a triangle</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deer.slopes</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.latitude</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.6</span><span class="p">),</span><span class="w">
               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deer.slopes</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decimal.latitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.3</span><span class="p">),</span><span class="w">
               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkgreen"</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">25</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Adding the icon using the coordinates on the x and y axis</span><span class="w">
    </span><span class="n">annotation_custom</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span><span class="w"> </span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-210</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-100</span><span class="p">,</span><span class="w"> </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-60</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-30</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Adding a title</span><span class="w">
    </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"a. Red Deer GBIF occurrences"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Let’s add some additional plots to our figure, for example how many occurrences there are for each year.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Visualise the number of occurrence records through time ----</span><span class="w">
</span><span class="c1"># This plot is more impressive if you have downloaded more records</span><span class="w">
</span><span class="c1"># as GBIF downloads the most recent records first</span><span class="w">
</span><span class="n">yearly.obs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deer.locations</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">group_by</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">tally</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="n">occurrences</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">yearly.obs</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'loess'</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of occurrences\n"</span><span class="p">,</span><span class="w">
         </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"b. GBIF occurrences\n"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># Use our customised theme, saves many lines of code!</span><span class="w">
    </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="c1"># if you want to change things about your theme, you need to include the changes after adding the theme</span><span class="w">
    </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">),</span><span class="w"> </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>We can add plots that show the population trends for those populations we’ve labelled. Given that we will be doing the same thing for multiple objects (the same type of plot for each population), we can practice functional programming and using <code class="language-plaintext highlighter-rouge">purrr</code> again here. The function looks very similar to a normal <code class="language-plaintext highlighter-rouge">ggplot2</code> code chunk, except we’ve wrapped it up in a function and we are not using any specific objects, just <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code> and <code class="language-plaintext highlighter-rouge">z</code> as the three arguments the function needs.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Visualise population trends ----</span><span class="w">
</span><span class="c1"># Visualising the population trends of four deer populations</span><span class="w">

</span><span class="c1"># Let's practice functional programming here</span><span class="w">
</span><span class="c1"># *** Functional Programming ***</span><span class="w">
</span><span class="c1"># Let's make a function to make the population trend plots</span><span class="w">
</span><span class="c1"># First we need to decide what values the function needs to take</span><span class="w">
</span><span class="c1"># x - The population data</span><span class="w">
</span><span class="c1"># y - the slope value</span><span class="w">
</span><span class="c1"># z - the location of the monitoring</span><span class="w">
</span><span class="c1"># This function needs to take three arguments</span><span class="w">

</span><span class="c1"># Let's make the ggplot function</span><span class="w">
</span><span class="n">pop.graph</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># Make a ggplot graph with the 'x'</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Shape 21 chooses a point with a black outline filled with aquamarine</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">21</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Adds a linear model fit, alpha controls the transparency of the confidence intervals</span><span class="w">
  </span><span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lm"</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aquamarine3"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.4</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Add the monitoring location 'y' into the plot</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Individuals\n"</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"c. "</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="s2">"\n"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Set the y limit to the maximum population for each 'x'</span><span class="w">
  </span><span class="n">ylim</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="n">x</span><span class="o">$</span><span class="n">pop</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Set the x limit to the range of years of data</span><span class="w">
  </span><span class="n">xlim</span><span class="p">(</span><span class="m">1970</span><span class="p">,</span><span class="w"> </span><span class="m">2010</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="c1"># Add the slope 'y' into the plot</span><span class="w">
  </span><span class="n">annotate</span><span class="p">(</span><span class="s2">"text"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1972</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">  </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-2</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"Slope ="</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_LPD</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span><span class="w"> </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">10</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We will focus on four populations in the USA, Switzerland and Canada. We will make three objects for each population, which represent the three arguments the function takes - the population data, the slope value and the location of the population. Then we will run our function <code class="language-plaintext highlighter-rouge">pop.graph()</code> using those objects.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find all unique ids for red deer populations</span><span class="w">
</span><span class="n">unique</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="p">)</span><span class="w">

</span><span class="c1"># Create an object each of the unique populations</span><span class="w">
</span><span class="c1"># Deer population 1 - Northern Yellowstone National Park</span><span class="w">
</span><span class="n">deer1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">deer.data</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"6395"</span><span class="p">)</span><span class="w">
</span><span class="n">slope_deer1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"6395"</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">location_deer1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"6395"</span><span class="p">]</span><span class="w">
</span><span class="n">yellowstone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop.graph</span><span class="p">(</span><span class="n">deer1</span><span class="p">,</span><span class="w"> </span><span class="n">location_deer1</span><span class="p">,</span><span class="w"> </span><span class="n">slope_deer1</span><span class="p">)</span><span class="w">

</span><span class="c1"># Deer population 2 - Mount Rainier National Park, USA</span><span class="w">
</span><span class="n">deer2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">deer.data</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"3425"</span><span class="p">)</span><span class="w">
</span><span class="n">slope_deer2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"3425"</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">location_deer2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"3425"</span><span class="p">]</span><span class="w">
</span><span class="n">rainier</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop.graph</span><span class="p">(</span><span class="n">deer2</span><span class="p">,</span><span class="w"> </span><span class="n">location_deer2</span><span class="p">,</span><span class="w"> </span><span class="n">slope_deer2</span><span class="p">)</span><span class="w">

</span><span class="c1"># Deer population 3 - Switzerland</span><span class="w">
</span><span class="n">deer3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">deer.data</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"11170"</span><span class="p">)</span><span class="w">
</span><span class="n">slope_deer3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"11170"</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">location_deer3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"11170"</span><span class="p">]</span><span class="w">
</span><span class="n">switzerland</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop.graph</span><span class="p">(</span><span class="n">deer3</span><span class="p">,</span><span class="w"> </span><span class="n">location_deer3</span><span class="p">,</span><span class="w"> </span><span class="n">slope_deer3</span><span class="p">)</span><span class="w">

</span><span class="c1"># Deer population 4 - Banff National Park, Alberta (there are more populations here)</span><span class="w">
</span><span class="n">deer4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">deer.data</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"4383"</span><span class="p">)</span><span class="w">
</span><span class="n">slope_deer4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"4383"</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">location_deer4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">location.of.population</span><span class="p">[</span><span class="n">deer.slopes</span><span class="o">$</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"4383"</span><span class="p">]</span><span class="w">
</span><span class="n">banff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pop.graph</span><span class="p">(</span><span class="n">deer4</span><span class="p">,</span><span class="w"> </span><span class="n">location_deer4</span><span class="p">,</span><span class="w"> </span><span class="n">slope_deer4</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>We are now ready to combine all of our graphs into one panel. When using <code class="language-plaintext highlighter-rouge">grid.arrange()</code>, you can add an additional argument <code class="language-plaintext highlighter-rouge">widths = c()</code> or <code class="language-plaintext highlighter-rouge">heights = c()</code>, which controls the ratios between the different plots. By default, <code class="language-plaintext highlighter-rouge">grid.arrange()</code> will give equal space to each graph, but sometimes you might want one graph to be wider than others, like here we want the map to have more space.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create panel of all graphs</span><span class="w">
</span><span class="c1"># Makes a panel of the map and occurrence plot and specifies the ratio</span><span class="w">
</span><span class="c1"># i.e., we want the map to be wider than the other plots</span><span class="w">
</span><span class="c1"># suppressWarnings() suppresses warnings in the ggplot call here</span><span class="w">
</span><span class="n">row1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">suppressWarnings</span><span class="p">(</span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">deer.map.final</span><span class="p">,</span><span class="w"> </span><span class="n">occurrences</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">widths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.96</span><span class="p">,</span><span class="w"> </span><span class="m">1.04</span><span class="p">)))</span><span class="w">
</span><span class="c1"># Makes a panel of the four population plots</span><span class="w">
</span><span class="n">row2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">yellowstone</span><span class="p">,</span><span class="w"> </span><span class="n">rainier</span><span class="p">,</span><span class="w"> </span><span class="n">switzerland</span><span class="p">,</span><span class="w"> </span><span class="n">banff</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">widths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">

</span><span class="c1"># Makes a panel of all the population plots and sets the ratio</span><span class="w">
</span><span class="c1"># Stich all of your plots together</span><span class="w">
</span><span class="n">deer.panel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">row1</span><span class="p">,</span><span class="w"> </span><span class="n">row2</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">heights</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.2</span><span class="p">,</span><span class="w"> </span><span class="m">0.8</span><span class="p">))</span><span class="w">

</span><span class="n">ggsave</span><span class="p">(</span><span class="n">deer.panel</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"deer_panel2.png"</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/deer_panel2.png" alt="Img" style="width: 900px;"> </center>

<h2 id="challenges">Challenges</h2>

<p><strong>Take what you have learned about pipes and make a map of the five most well-sampled populations in the LPD database (the ones with the most replicate populations) and colour code the points by the population trend (derived from the models we did) and the size by the duration of the time series. You can try incorporating a handwritten function to make the map and using purr to implement that function, or you can go straight into <code class="language-plaintext highlighter-rouge">ggplot2</code>.</strong></p>

<p><strong>Pick a country and species of your choice. Download the GBIF records for that species from your selected country (or you can do the world if you don’t mind waiting a few more minutes for the GBIF data to download). Plot where the species occurs. Then, add the locations of the Living Planet Database populations of the same species - do we have long-term records from the whole range of the species? Where are the gaps? You can have a go at combining the LPD and GBIF databases in a meaningful way - hint: look up the different joining functions from <code class="language-plaintext highlighter-rouge">dplyr</code> - <code class="language-plaintext highlighter-rouge">left_join()</code>, <code class="language-plaintext highlighter-rouge">inner_join()</code>, etc.</strong></p>

<p><strong>Use another projection for the map - the default is Mercator, but that’s not the best way to represent the world. Hint - you can still use <code class="language-plaintext highlighter-rouge">ggplot2</code> - look up the <code class="language-plaintext highlighter-rouge">proj4</code> package and how to combine it with <code class="language-plaintext highlighter-rouge">ggplot2</code>.</strong></p>

<h2 id="extra-resources">Extra resources</h2>

<p>You can find more info on <code class="language-plaintext highlighter-rouge">pander</code> <a href="https://cran.r-project.org/web/packages/pander/pander.pdf" target="_blank" rel="noopener noreferrer"> here</a>.</p>

<p>To learn more about the power of pipes check out:
<a href="http://dplyr.tidyverse.org/" target="_blank" rel="noopener noreferrer"> the tidyverse website</a> and <a href="http://r4ds.had.co.nz/pipes.html" target="_blank" rel="noopener noreferrer"> the R for Data Science book</a>.</p>

<p>To learn more about <code class="language-plaintext highlighter-rouge">purrr</code> check out the <a href="http://purrr.tidyverse.org/reference/map2.html" target="_blank" rel="noopener noreferrer">tidyverse website</a> and the <a href="http://r4ds.had.co.nz/iteration.html" target="_blank" rel="noopener noreferrer"> R for Data Science book</a>.</p>

<p>For more information on functional programming see the <a href="http://r4ds.had.co.nz/functions.html" target="_blank" rel="noopener noreferrer">R for Data Science book chapter here</a>.</p>

<p>To learn more about the <code class="language-plaintext highlighter-rouge">tidyverse</code> in general, check out Charlotte Wickham’s slides <a href="https://github.com/cwickham/data-science-in-tidyverse/tree/master/slides" target="_blank" rel="noopener noreferrer">here</a>.</p>

<hr>

<hr>

<h3><a href="https://www.surveymonkey.com/r/XD85MW5" target="_blank" rel="noopener noreferrer">  We would love to hear your feedback, please fill out our survey!</a></h3>

<p><br></p>
<h3>  You can contact us with any questions on <a href="mailto:ourcodingclub@gmail.com?Subject=Tutorial%20question" target="_top">ourcodingclub@gmail.com</a>
</h3>
<p><br></p>
<h3>  Related tutorials:</h3>

<p><br></p>
<h3>  Subscribe to our mailing list:</h3>
<div class="container">
	<div class="block">
        <!-- subscribe form start -->
		<div class="form-group">
			<form action="https://getsimpleform.com/messages?form_api_token=de1ba2f2f947822946fb6e835437ec78" method="post">
			<div class="form-group">
				<input type="text" class="form-control" name="Email" placeholder="Email" required="">
			</div>
			<div>
                        	<button class="btn btn-default" type="submit">Subscribe</button>
                    	</div>
                	</form>
		</div>
	</div>
</div>

<ul class="social-icons">
	<li>
		<h3>
			<a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer"> Follow our coding adventures on Twitter! <i class="fa fa-twitter"></i></a>
		</h3>
	</li>
</ul>

    	<footer class="footer">
	<hr>
	<div class="footer-container">
    	<ul class="footer-link-list">
        	<li><a href="/tutorials">Tutorials</a></li>
        	<li><a href="/team">About Us</a></li>
        	<li><a href="/contact">Contact us</a></li>
	    	<li><a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer">Follow us on Twitter</a></li>
    	</ul>
    	<div class="footer-text">
			<p>We are happy for people to use and further develop our tutorials - please give credit to Coding Club by linking to <a href="https://ourcodingclub.github.io/" target="_blank" rel="noopener noreferrer">our website</a>. We are also happy to discuss possible collaborations, so get in touch at <b>ourcodingclub@gmail.com</b></p>
    		<p>See our <a href="/terms">Terms of Use</a> and our <a href="/privacy">Data Privacy policy</a>.</p>
			<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-ShareAlike 4.0 International License</a></p>
			<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img class="license" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="CC-by-sa-4.0"></a>
    	</div>
    </div>
</footer>

<!-- JS -->
<script src="/scripts/owl.carousel.js"></script>
<script src="/scripts/owl.carousel-init.js"></script>
<script src="/scripts/reveal.js"></script>


	
	</body>
</html>
