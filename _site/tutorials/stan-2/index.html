<!DOCTYPE html>
<html lang="en-GB">
	<head>
    	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Generalised linear models in Stan</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSS -->
<link rel="stylesheet" href="/css/main.css"/>
<link rel="stylesheet" href="/css/owlcarousel/owl.carousel.css">
<link rel="stylesheet" href="/css/owlcarousel/owl.theme.default.css">

<!-- JS -->
<script src="https://use.fontawesome.com/4dd22df1f8.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="/scripts/accordion.js"></script>
<script src="/scripts/jquery.counterup.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/2.0.5/waypoints.min.js"></script>
<script src="/scripts/ticker.js"></script>

	</head>
	<body>
    	<header class="header">
	<div class="navigation-bar">
		<div id="navigation-container">
			
				<a class="logo" href="/">
  <img src="/assets/img/logos/logo_stack.svg" alt="Coding Club logo">
</a>

			
			<nav>
				<label for="hamburger">☰</label>
				<input type="checkbox" id="hamburger">
				<ul>
					
						
					<li class="item item-nav">
						<a href="/">Home</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/tutorials.html">Tutorials</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/course.html">Course</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/team.html">Team</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/involve.html">Get involved</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/links.html">Links</a>
					</li>
					
						
					<li class="item item-nav">
						<a href="/contact.html">Contact</a>
					</li>
					
				</ul>
			</nav>
		</div>
	</div>
</header>

			<div class="block">
	<center>
		<img src="/img/tutheader_stan2.png" alt="Img">
	</center>
</div>

<h3 id="tutorial-aims">Tutorial Aims:</h3>

<h4 id="-1-learn-about-generalised-models-in-stan"><a href="#model"> 1. Learn about generalised models in <code class="language-plaintext highlighter-rouge">Stan</code></a></h4>
<h4 id="-2-use-the-rstanarm-package-to-run-a-poisson-model"><a href="#rstanarm"> 2. Use the <code class="language-plaintext highlighter-rouge">rstanarm</code> package to run a <code class="language-plaintext highlighter-rouge">Poisson</code> model</a></h4>
<h4 id="-3-assess-model-convergence-"><a href="#assess"> 3. Assess model convergence </a></h4>
<h4 id="-4-check-priors-in-rstanarm-"><a href="#priors"> 4. Check priors in <code class="language-plaintext highlighter-rouge">rstanarm</code> </a></h4>
<h4 id="-5-extract-stan-code"><a href="#code"> 5. Extract <code class="language-plaintext highlighter-rouge">Stan</code> code</a></h4>
<h4 id="-6-run-a-model-with-a-negative-binomial-distribution-"><a href="#negbin"> 6. Run a model with a negative binomial distribution </a></h4>
<h4 id="-7-compare-rstanarm-and-brms"><a href="#brms"> 7. Compare <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code></a></h4>

<h3 id="all-the-files-you-need-to-complete-this-tutorial-can-be-downloaded-from-this-repository-click-on-clonedownloaddownload-zip-and-unzip-the-folder-or-clone-the-repository-to-your-own-github-account">All the files you need to complete this tutorial can be downloaded from <a href="https://github.com/ourcodingclub/CC-Stan-2" target="_blank" rel="noopener noreferrer">this repository</a>. Click on <code class="language-plaintext highlighter-rouge">Clone/Download/Download ZIP</code> and unzip the folder, or clone the repository to your own GitHub account.</h3>

<p><a name="model"></a></p>

<h2 id="introduction">Introduction</h2>

<p><strong>Finding answers to our research questions often requires statistical models. Designing models, choosing what variables to include, which data distribution to use are all worth thinking about carefully. In this tutorial, we will continue exploring different model structures in search of the best way to find the answers to our research questions. We will build on the Coding Club tutorials on <a href="/tutorials/model-design/index.html" target="_blank"> how to design a model</a>, and on<a href="/tutorials/mcmcglmm/index.html" target="_blank">Bayesian Modelling in <code class="language-plaintext highlighter-rouge">MCMCglmm</code></a> for key background information on model design and Bayesian statistics.</strong></p>

<p><strong>Statistical models can be fit in a variety of packages in <code class="language-plaintext highlighter-rouge">R</code> or other statistical languages. But sometimes the perfect model that you can design conceptually is very hard or impossible to implement in a package or programme that restricts the distributions and complexity that you can use. This is when you may want to move to a statistical programming language such as <a href="http://mc-stan.org/" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">Stan</code></a>. For an introduction to <code class="language-plaintext highlighter-rouge">Stan</code>, you can check out our <a href="/tutorials/stan-intro/index.html" target="_blank">intro tutorial here</a>.</strong></p>

<p><a name="rstanarm"></a></p>

<p>In this tutorial, we will learn about two packages, <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> which allow us to fit <code class="language-plaintext highlighter-rouge">Stan</code> models using syntax similar to packages like <code class="language-plaintext highlighter-rouge">lme4</code>, <code class="language-plaintext highlighter-rouge">nlme</code> and <code class="language-plaintext highlighter-rouge">MCMCglmm</code>. We will use these packages to fit models that test how species richness has changed over time near <a href="http://arc-lter.ecosystems.mbl.edu/terrestrial-data" target="_blank" rel="noopener noreferrer">Toolik Lake Field Station</a>.</p>

<h3 id="research-question-how-has-plant-species-richness-changed-over-time-at-toolik-lake">Research question: How has plant species richness changed over time at Toolik Lake?</h3>

<h3 id="hypothesis-plant-species-richness-has-increased-over-time-at-toolik-lake">Hypothesis: Plant species richness has increased over time at Toolik Lake.</h3>

<p>We can start with loading the libraries we will need and the data we will use. If you don’t have some of these packages installed, you can install them using <code class="language-plaintext highlighter-rouge">install.packages("package-name")</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load libraries ----</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rstanarm</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">brms</span><span class="p">)</span><span class="w">  </span><span class="c1"># for models</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bayesplot</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidybayes</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">modelr</span><span class="p">)</span><span class="w">

</span><span class="c1"># Load data ----</span><span class="w">
</span><span class="c1"># Remember to set your working directory to the folder</span><span class="w">
</span><span class="c1"># where you saved the workshop files</span><span class="w">
</span><span class="n">toolik_richness</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"toolik_richness.csv"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Inspect data</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">toolik_richness</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>To check out what class of data we are dealing with we can use the str() function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">str</span><span class="p">(</span><span class="n">toolik_richness</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Site</code> and <code class="language-plaintext highlighter-rouge">Species</code> are strings (letters) and categorical data (factors) - they are names.  <code class="language-plaintext highlighter-rouge">Year</code>, <code class="language-plaintext highlighter-rouge">Cover</code>, <code class="language-plaintext highlighter-rouge">Mean.Temp</code> and <code class="language-plaintext highlighter-rouge">SD.Temp</code> are numeric and continuous data - they are numbers. <code class="language-plaintext highlighter-rouge">Cover</code> shows the relative cover (out of 1) for different plant species, <code class="language-plaintext highlighter-rouge">Mean.Temp</code> is the mean annual temperature at Toolik Lake Station and <code class="language-plaintext highlighter-rouge">SD.Temp</code> is the standard deviation of the mean annual temperature. Then we have <code class="language-plaintext highlighter-rouge">Treatment</code>, another categorical variable that refers to different chemical treatments, e.g. some plots received extra nitrogen, others extra phosphorus. Finally, we have <code class="language-plaintext highlighter-rouge">Block</code> and <code class="language-plaintext highlighter-rouge">Plot</code>, which give more detailed information about where the measurements were taken.</p>

<p>The plot numbers are currently coded as numbers - 1, 2,…8 and they are a numerical variable. We should make them a categorical variable, since just like <code class="language-plaintext highlighter-rouge">Site</code> and <code class="language-plaintext highlighter-rouge">Block</code>, the numbers represent the different categories, not actual count data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">toolik_richness</span><span class="o">$</span><span class="n">Plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="nf">as.character</span><span class="p">(</span><span class="n">toolik_richness</span><span class="o">$</span><span class="n">Plot</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now, let’s think about the distribution of the data, specifically our response variable, species richness (<code class="language-plaintext highlighter-rouge">Richness</code>).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">hist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggplot</span><span class="p">(</span><span class="n">toolik_richness</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Richness</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_histogram</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">theme_classic</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<p>Note that putting your entire ggplot code in brackets () creates the graph and then shows it in the plot viewer. If you don’t have the brackets, you’ve only created the object, but haven’t visualized it. You would then have to call the object such that it will be displayed by just typing <code class="language-plaintext highlighter-rouge">hist</code> after you’ve created the “hist” object.</p>

<center> <img src="/img/richness_hist.png" alt="Img" style="width: 500px;"> </center>

<p><strong>We are working with integers (similar to count data, species only come in whole numbers) and the data are right-skewed, that is because we have a few data points on the extreme right end, they are pulling the mean and median or our data to the right. For ecological data, this is quite common - across all of the sampling plots, we expect that they won’t all have lots of different species within them.</strong></p>

<p><strong>This means that a <code class="language-plaintext highlighter-rouge">Poisson</code> distribution might be suitable for our model.</strong></p>

<p>One advantage to fitting models in <code class="language-plaintext highlighter-rouge">Stan</code> is that it’s easy to fully take advantage of your computing power. In <code class="language-plaintext highlighter-rouge">Stan</code>, we usually run two or more <strong>chains</strong> - different iterations of our model which we can then compare - if they are massively different, something is not right. If your computer has two or more cores, you can split the chains, i.e., run a chain on each core, saving you some time, as the code will then finish running quicker. This means that you’ll be running the code in parallel.</p>

<p>To enable parallel computing, you can run this line of code and then later on in the model code, you can specify how many cores you want to use.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">options</span><span class="p">(</span><span class="n">mc.cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parallel</span><span class="o">::</span><span class="n">detectCores</span><span class="p">())</span><span class="w">
</span></code></pre></div></div>

<p><strong>Now we are all set up for our first model. Remember that the data have a hierarchical structure - species richness is measured in plots, which fall within blocks that are then part of different sites. To derive inferences about changes species richness through time, our models should take this complexity of the data structure into account.</strong></p>

<p>One disadvantage to <code class="language-plaintext highlighter-rouge">Stan</code> models is that the code can take a while to finish running, even if we use  all of our computer cores, it can still be hours before you can see a summary of your model. Of course, one should use the most suitable type of model for a research question, regardless of how long the model takes to run (within reason…), but in our case, for teaching purposes and so that you can see some model outputs today, we will focus on species richness change within just one of the plots. In that case, the model does not need to include random effects, because on the plot level, there is no replication.</p>

<p>Just so that you know what the syntax looks like and if you have time to wait for this code to finish running, this is how the model for species richness change around Toolik Lake in general would look like:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Note - this code could take hours to run!</span><span class="w">
</span><span class="c1"># We are running the model using the default weakly informative priors.</span><span class="w">
</span><span class="c1"># More about priors coming later in the tutorial!</span><span class="w">
</span><span class="c1"># stan_lm &lt;- stan_glmer(Richness ~ I(Year-2007) + (1|Site/Block/Plot),</span><span class="w">
</span><span class="c1">#                     data = toolik_richness, family = poisson,</span><span class="w">
</span><span class="c1">#                     chains = 4, cores = 4)</span><span class="w">

</span><span class="c1"># Assess converge by looking at the trace plots</span><span class="w">
</span><span class="c1"># plot(stan_lm, plotfun = "trace")</span><span class="w">

</span><span class="c1"># Explore the summary output</span><span class="w">
</span><span class="c1"># summary(stan_lm)</span><span class="w">
</span></code></pre></div></div>

<p><strong>For teaching purposes only, we will proceed with a model without random effects - that way you can see the outputs of the models as you are going through the tutorial. Note that we do not advise doing this when you are analysing your data for real - of course a model that takes into account the hierarchical structure of the data would be better.</strong></p>

<h3 id="advantages-and-disadvantages-of-using-stan">Advantages and disadvantages of using <code class="language-plaintext highlighter-rouge">Stan</code>
</h3>
<p><code class="language-plaintext highlighter-rouge">Stan</code> models can take a long time to compile. One of their key advantage is that you have a lot of freedom to specify the priors (your prior knowledge and expectations of how a given parameter will behave) for your model parameters and you can really account for the complex structure your data might have. There is a time cost to this, as we’ve seen above. One way to approach this is to first make sure your code works on a small chunk of your data, and only afterwards, you can start running the code on the full data (and do other things while you wait for the models to compile).</p>

<p>Now we can run our simplified model. First, let’s check how many years of data we have:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique</span><span class="p">(</span><span class="n">toolik_richness</span><span class="o">$</span><span class="n">Year</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>There are four years of data from 2008 to 2012. For modelling purposes, it helps to transform the year variable into a continuous variable where the first year is year one, i.e., 2008 is 1, 2009 is 2. That way, the model won’t have to estimate  richness in the year 500, the year 501, etc., it will start straight from our first monitoring year.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Note how now we are using stan_glm because</span><span class="w">
</span><span class="c1"># there are no random effects</span><span class="w">
</span><span class="n">stan_glm1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stan_glm</span><span class="p">(</span><span class="n">Richness</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">Year</span><span class="m">-2007</span><span class="p">),</span><span class="w">
                     </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toolik_richness</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poisson</span><span class="p">,</span><span class="w">
                     </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>If you find this code still takes a long time, you can change the <code class="language-plaintext highlighter-rouge">chains</code> argument to only two chains, but note that it’s better to run models with more than two chains - then you have more room for comparison. If one or more of the four chains is behaving really differently from the rest, then the model might not have converged. What is model convergence? In brief, if a model hasn’t converged, you can’t trust the estimates it gives you. You can find more details in <a href="/tutorials/model-design/index.html" target="_blank"> the model design tutorial here</a>.</p>

<p><a name="assess"></a></p>

<h2 id="assessing-model-convergence">Assessing model convergence</h2>

<p><strong>One way to assess model convergence is by visually examining the trace plots. They should be fuzzy with no big gaps, breaks or gigantic spikes.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trace"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/stan2_traces.png" alt="Img" style="width: 900px;"> </center>
<p>Here, the trace plots look fine.</p>

<p>Next we can look at the summary output.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">summary</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/stan2_summary.png" alt="Img" style="width: 500px;"> </center>

<p><strong>We can see that the effective sample size is alright (there is no hard cut threshold, but more than around 1000 is usually a good sign), another diagnostic metric, the <code class="language-plaintext highlighter-rouge">Rhat</code> value is also indicating convergence (an <code class="language-plaintext highlighter-rouge">Rhat</code> of 1 is a good sign, more than 1 could indicate trouble).</strong></p>

<h2 id="posterior-predictive-checks">Posterior predictive checks</h2>

<p>The pre-compiled models in <code class="language-plaintext highlighter-rouge">rstanarm</code> already include a <code class="language-plaintext highlighter-rouge">y_rep</code> variable (our model predictions) in the generated quantities block (your posterior distributions). We can use the <code class="language-plaintext highlighter-rouge">pp_check</code> function from the <code class="language-plaintext highlighter-rouge">bayesplot</code> package to see how the model predictions compare to the raw data, i.e., is the model behaving as we expect it to be?</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pp_check</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stat"</span><span class="p">,</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mean"</span><span class="p">)</span><span class="w">
</span><span class="n">pp_check</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dens_overlay"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center>
<img src="/img/stan2_hist.png" alt="Img" style="width: 500px;"> <img src="/img/stan2_density.png" alt="Img" style="width: 500px;"> </center>

<p><strong>What do you think? How does the density distribution of the model predictions compare with that of the raw data?</strong></p>

<p>From the histogram, we can see that the posterior mean (the dark blue line) aligns well with the raw data. From the density plot, we can see that the model is underpredicting the low species richness value. This is a common problem when working with left-skewed or zero/low number-inflated data. Overall though, the model predictions follow the underlying data, so in summary, we can say that this model fit is acceptable. Note that these decisions can vary based on your question, data and even your statistical philosophy.</p>

<h2 id="model-diagnostics-using-shinystan">Model diagnostics using <code class="language-plaintext highlighter-rouge">shinystan</code>
</h2>

<p>For an interactive exploration of <code class="language-plaintext highlighter-rouge">Stan</code> models, you can use the <code class="language-plaintext highlighter-rouge">shinystan</code> app. The app is compatible with <code class="language-plaintext highlighter-rouge">Stan</code> models generated using the <code class="language-plaintext highlighter-rouge">rstan</code>, <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> packages, so regardless of how you chooose to run your <code class="language-plaintext highlighter-rouge">Stan</code> models, you can still use <code class="language-plaintext highlighter-rouge">shinystan</code> to assess whether or not they’ve converged and are behaving properly.</p>

<p>We can launch the app using the code below. That will open a window in our internet browser, where we can further explore our model.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">launch_shinystan</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center> <img src="/img/shinystan.png" alt="Img" style="width: 900px;"> </center>

<p>Have a go at exploring the various options - you’ll probably spot some of the plots we’ve already made in <code class="language-plaintext highlighter-rouge">R</code>, but there are many others as well. Here, for example, if there were any divergent chains (i.e. a chain that is behaving in a very weird unexpected way), we would have seen red points. In our case, we don’t have any divergent chains.</p>

<center> <img src="/img/shinystan2.png" alt="Img" style="width: 900px;"> </center>

<h3 id="back-to-our-research-question">Back to our research question</h3>

<p><strong>How has species richness changed over those four years near Toolik lake?</strong></p>

<p>To get the answer, we can plot the model predictions for our model as well as the raw data points.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">model_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">toolik_richness</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">data_grid</span><span class="p">(</span><span class="n">Year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq_range</span><span class="p">(</span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">101</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">add_predicted_draws</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Year</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Richness</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">stat_lineribbon</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">.prediction</span><span class="p">),</span><span class="w"> </span><span class="n">.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">.95</span><span class="p">,</span><span class="w"> </span><span class="m">.80</span><span class="p">,</span><span class="w"> </span><span class="m">.50</span><span class="p">),</span><span class="w">
                  </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toolik_richness</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"darkseagreen4"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_brewer</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Greys"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p><strong>Looks like species richness is decreasing, but also, four years of data is not enough to really test temporal dynamics!</strong></p>

<center> <img src="/img/stan_pred.png" alt="Img" style="width: 500px;"> </center>

<p><a name="priors"></a></p>

<h2 id="priors">Priors</h2>

<p>Packages like <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> allow us to fit <code class="language-plaintext highlighter-rouge">Stan</code> models using simple and quick code syntax. One danger though is that along the way, we might forget to think about our priors! In the code above, we have not specified any priors. In that case, the model uses the default <code class="language-plaintext highlighter-rouge">rstanarm</code> priors.</p>

<p>We should check what those are whether they match our expectations of the data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prior_summary</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Priors for model 'stan_glm1'
------
Intercept (after predictors centered)
 ~ normal(location = 0, scale = 10)

Coefficients
 ~ normal(location = 0, scale = 2.5)
     **adjusted scale = 1.58
</code></pre></div></div>

<p>The default priors are <code class="language-plaintext highlighter-rouge">normal(0,10)</code> for the intercept and <code class="language-plaintext highlighter-rouge">normal(0, 2.5)</code> for the slope. On a first glance, those may seem fairly informative, but it’s important to note that <code class="language-plaintext highlighter-rouge">rstanarm</code> automatically centers and scales the data for the model variables (this helps with model convergence), in which case these are weakly informative priors which are suitable for our research question here and the data we have on plant species richness.</p>

<p>If you would like to change the priors, you can add code, for example <code class="language-plaintext highlighter-rouge">prior = normal(0, 1), prior_intercept = normal(0, 5)</code> inside the <code class="language-plaintext highlighter-rouge">stan_glm()</code> function.</p>

<p><a name="ode"></a></p>

<h2 id="extract-stan-code-from-an-rstanarm-model">Extract <code class="language-plaintext highlighter-rouge">Stan</code> code from an <code class="language-plaintext highlighter-rouge">rstanarm</code> model</h2>

<p>When using packages like <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> which you will see in a bit, it’s a good idea to actually look at the <code class="language-plaintext highlighter-rouge">Stan</code> code behind the model.</p>

<p>You can extract the code with the following function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stancode</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rstan</span><span class="o">::</span><span class="n">get_stancode</span><span class="p">(</span><span class="n">stan_glm1</span><span class="o">$</span><span class="n">stanfit</span><span class="p">)</span><span class="w">
</span><span class="n">cat</span><span class="p">(</span><span class="n">stancode</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>You’ll see a lot of code appear in the console - this is what <code class="language-plaintext highlighter-rouge">rstanarm</code> has “written” for you. Amidst the many letters, you can see that the overall structure is like the <code class="language-plaintext highlighter-rouge">Stan</code> models we wrote in <a href="/tutorials/stan-intro/index.html" target="_blank">our intro <code class="language-plaintext highlighter-rouge">Stan</code> tutorial</a> - first, we state the parameters for the data, the data gets transformed (scaled and centered), then we define our model and finally, we calculate the predictions in the generated quantities block.</p>

<p><a name="negbin"></a></p>

<h2 id="explore-a-model-using-a-negative-binomial-distribution">Explore a model using a negative binomial distribution</h2>

<p>Up until now, we’ve been using a <code class="language-plaintext highlighter-rouge">Poisson</code> distribution for our models, which is suitable for when we are working with discrete count data. The <a href="https://en.wikipedia.org/wiki/Poisson_distribution" target="_blank" rel="noopener noreferrer">Poisson distribution</a> assumes that the mean and variance are the same. In ecology and probably other disciplines too, the data might have variance greater than the mean. In this case, we call the data <a href="https://en.wikipedia.org/wiki/Overdispersion" taget="_blank" target="_blank" rel="noopener noreferrer">overdispersed</a>. The negative binomial distribution adjusts the variance independently from the mean and as such is more flexible than Poisson. The Poisson distribution is actually a type of a negative binomial distribution.</p>

<p><strong>In <code class="language-plaintext highlighter-rouge">rstanarm</code>, it’s easy to <em>update</em> a model using a different data distribution. In our case, we can try a negative binomial distribution.</strong></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stan_glm2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">stan_glm1</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">neg_binomial_2</span><span class="p">)</span><span class="w">

</span><span class="c1"># Check convergence &amp; priors</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">stan_glm2</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trace"</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">stan_glm2</span><span class="p">)</span><span class="w">
</span><span class="n">prior_summary</span><span class="p">(</span><span class="n">stan_glm2</span><span class="p">)</span><span class="w">

</span><span class="c1"># Posterior Predictive Checks</span><span class="w">
</span><span class="n">pp_check</span><span class="p">(</span><span class="n">stan_glm2</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"stat"</span><span class="p">,</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mean"</span><span class="p">)</span><span class="w">
</span><span class="n">pp_check</span><span class="p">(</span><span class="n">stan_glm2</span><span class="p">,</span><span class="w"> </span><span class="n">plotfun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"dens_overlay"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<center>
<img src="/img/stan2_hist.png" alt="Img" style="width: 500px;"> <img src="/img/stan2_density.png" alt="Img" style="width: 500px;"> </center>

<p>You can see that the model outputs are very similar - this is to be expected, because the Poisson distribution is actually a type of a negative binomial distribution. Once again, the model is underpredicting the frequency of low species richness values.</p>

<p><a name="brms"></a></p>

<h2 id="run-a-stan-model-using-the-brms-package">Run a <code class="language-plaintext highlighter-rouge">Stan</code> model using the <code class="language-plaintext highlighter-rouge">brms</code> package</h2>

<p><code class="language-plaintext highlighter-rouge">brms</code> is another package that serves a similar purpose to <code class="language-plaintext highlighter-rouge">rstanarm</code> - it allows you to run <code class="language-plaintext highlighter-rouge">Stan</code> models using simple code syntax. <code class="language-plaintext highlighter-rouge">brms</code> writes all Stan models from scratch and has to compile them, while <code class="language-plaintext highlighter-rouge">rstanarm</code> comes with precompiled code (so when we were running our <code class="language-plaintext highlighter-rouge">rstanarm</code> models earlier, you didn’t see any messages about <code class="language-plaintext highlighter-rouge">C++</code> compiling, since that was already done in advance).</p>

<p>The results of the models ran using the different packages should not be different any more than is to be expected by chance (every time you re-run a model using Bayesian inference, the results will be a tiny bit different, because of how the posterior sampling is done, but those differences are of very small magnitudes, like between <code class="language-plaintext highlighter-rouge">0.19887</code> and <code class="language-plaintext highlighter-rouge">0.19884</code>).</p>

<p>One advantage of <code class="language-plaintext highlighter-rouge">brms</code> is that the <code class="language-plaintext highlighter-rouge">Stan</code> code you can extract from it is much easier to read than the <code class="language-plaintext highlighter-rouge">Stan</code> code coming from <code class="language-plaintext highlighter-rouge">rstanarm</code>. We can fit a <code class="language-plaintext highlighter-rouge">brms</code> model to check it out.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stan_glm_brms</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brm</span><span class="p">(</span><span class="n">bf</span><span class="p">(</span><span class="n">Richness</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">I</span><span class="p">(</span><span class="n">Year</span><span class="m">-2007</span><span class="p">),</span><span class="w">
                      </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brmsfamily</span><span class="p">(</span><span class="s1">'poisson'</span><span class="p">)),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toolik_richness</span><span class="p">,</span><span class="w">
                   </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w">
                   </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">

</span><span class="n">summary</span><span class="p">(</span><span class="n">stan_glm_brms</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">stan_glm_brms</span><span class="p">)</span><span class="w">

</span><span class="c1"># Extract Stan code</span><span class="w">
</span><span class="c1"># The code is nicely annotated, so you can read through</span><span class="w">
</span><span class="n">stancode</span><span class="p">(</span><span class="n">stan_glm_brms</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>In this tutorial we learned to fit <code class="language-plaintext highlighter-rouge">Stan</code> models in <code class="language-plaintext highlighter-rouge">R</code> using the <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> packages which write the <code class="language-plaintext highlighter-rouge">Stan</code> code for us, so they can be seen as a gentler introduction to <code class="language-plaintext highlighter-rouge">Stan</code>. We looked at two different data distributions that are suitable for left-skewed discrete count data - <code class="language-plaintext highlighter-rouge">Poisson</code> and <code class="language-plaintext highlighter-rouge">negative binomial</code>. If you are keen to get back into <code class="language-plaintext highlighter-rouge">Stan</code> coding, we’ve showed how to extract the <code class="language-plaintext highlighter-rouge">Stan</code> code behind the <code class="language-plaintext highlighter-rouge">rstanarm</code> and <code class="language-plaintext highlighter-rouge">brms</code> models, so you can take that code and develop it further. You can check out our other <a href="/tutorials/stan-intro/index.html" target="_blank"><code class="language-plaintext highlighter-rouge">Stan</code> tutorial</a>. to see how to write and run <code class="language-plaintext highlighter-rouge">Stan</code> code using the <code class="language-plaintext highlighter-rouge">rstan</code> package.</p>

<h2 id="further-resources">Further resources</h2>

<p><a href="https://cran.r-project.org/web/packages/rstanarm/rstanarm.pdf" target="_blank" rel="noopener noreferrer">rstanarm vignette</a></p>

<p><a href="https://cran.r-project.org/web/packages/brms/brms.pdf" target="_blank" rel="noopener noreferrer">brms vignette</a></p>

<p><a href="https://cran.r-project.org/web/packages/rstanarm/vignettes/rstanarm.html" target="_blank" rel="noopener noreferrer">How to Use the rstanarm Package by Jonah Gabry and Ben Goodrich </a></p>

<p><a href="http://mc-stan.org/" target="_blank" rel="noopener noreferrer">Stan website</a></p>

<p><a href="https://github.com/stan-dev/stan/releases/download/v2.14.0/stan-reference-2.14.0.pdf" target="_blank" rel="noopener noreferrer">Stan manual(v2.14)</a></p>

<p><a href="https://cran.r-project.org/web/packages/rstan/vignettes/rstan.html" target="_blank" rel="noopener noreferrer">Rstan vignette</a></p>

<p><a href="https://t.co/6d3omvBkrd" target="_blank" rel="noopener noreferrer">STANCON 2017 Intro Course Materials</a></p>

<p><a href="http://xcelab.net/rm/statistical-rethinking/" target="_blank" rel="noopener noreferrer">Statistical Rethinking by R. McElreath</a></p>

<p><a href="https://groups.google.com/forum/#!forum/stan-users" target="_blank" rel="noopener noreferrer">Stan mailing list</a></p>

<hr>

<hr>

<p><strong>Check out <a href="/workshop.html" target="_blank">this page</a> to learn how you can get involved! We are very happy to have people use our tutorials and adapt them to their needs. We are also very keen to expand the content on the website, so feel free to get in touch if you’d like to write a tutorial!</strong></p>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-ShareAlike 4.0 International License</a>. <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="Img" style="width: 100px;"></a></p>

<h3><a href="https://www.surveymonkey.co.uk/r/PX3XHD2" target="_blank" rel="noopener noreferrer">  We would love to hear your feedback, please fill out our survey!</a></h3>

<p><br></p>
<h3>  You can contact us with any questions on <a href="mailto:ourcodingclub@gmail.com?Subject=Tutorial%20question" target="_top">ourcodingclub@gmail.com</a>
</h3>
<p><br></p>
<h3>  Related tutorials:</h3>

<ul>
  
  
</ul>

<p><br></p>
<h3>  Subscribe to our mailing list:</h3>
<div class="container">
	<div class="block">
        <!-- subscribe form start -->
		<div class="form-group">
			<form action="https://getsimpleform.com/messages?form_api_token=de1ba2f2f947822946fb6e835437ec78" method="post">
			<div class="form-group">
				<input type="text" class="form-control" name="Email" placeholder="Email" required="">
			</div>
			<div>
                        	<button class="btn btn-default" type="submit">Subscribe</button>
                    	</div>
                	</form>
		</div>
	</div>
</div>

<ul class="social-icons">
	<li>
		<h3>
			<a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer"> Follow our coding adventures on Twitter! <i class="fa fa-twitter"></i></a>
		</h3>
	</li>
</ul>

    	<footer class="footer">
	<hr>
	<div class="footer-container">
    	<ul class="footer-link-list">
        	<li><a href="/tutorials">Tutorials</a></li>
        	<li><a href="/team">About Us</a></li>
        	<li><a href="/contact">Contact us</a></li>
	    	<li><a href="https://twitter.com/our_codingclub" target="_blank" rel="noopener noreferrer">Follow us on Twitter</a></li>
    	</ul>
    	<div class="footer-text">
			<p>We are happy for people to use and further develop our tutorials - please give credit to Coding Club by linking to <a href="https://ourcodingclub.github.io/" target="_blank" rel="noopener noreferrer">our website</a>. We are also happy to discuss possible collaborations, so get in touch at <b>ourcodingclub@gmail.com</b></p>
    		<p>See our <a href="/terms">Terms of Use</a> and our <a href="/privacy">Data Privacy policy</a>.</p>
			<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-ShareAlike 4.0 International License</a></p>
			<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer"><img class="license" src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="CC-by-sa-4.0"></a>
    	</div>
    </div>
</footer>

<!-- JS -->
<script src="/scripts/owl.carousel.js"></script>
<script src="/scripts/owl.carousel-init.js"></script>
<script src="/scripts/reveal.js"></script>


	
	</body>
</html>
